# SpringCloud

## 1.æœåŠ¡æ¶æ„çš„æ¼”å˜

~~~
1ã€é›†ä¸­å¼æ¶æ„
2ã€å‚ç›´æ‹†åˆ†
3ã€åˆ†å¸ƒå¼æœåŠ¡
4ã€æœåŠ¡æ²»ç†SOA
5ã€å¾®æœåŠ¡
~~~

### 1ã€é›†ä¸­å¼æ¶æ„

![](SpringCloud.assets/Snipaste_2022-04-16_12-30-11.png)

ç¼ºç‚¹ï¼š

- ä»£ç è€¦åˆï¼Œå¼€å‘ç»´æŠ¤å›°éš¾
- æ— æ³•é’ˆå¯¹ä¸åŒæ¨¡å—è¿›è¡Œé’ˆå¯¹æ€§ä¼˜åŒ–
- æ— æ³•æ°´å¹³æ‰©å±•
- å•ç‚¹å®¹é”™ç‡ä½ï¼Œå¹¶å‘èƒ½åŠ›å·®

### 2ã€å‚ç›´æ‹†åˆ†

![](SpringCloud.assets/Snipaste_2022-04-16_12-35-09.png)

ä¼˜ç‚¹ï¼š

- ç³»ç»Ÿæ‹†åˆ†å®ç°äº†æµé‡åˆ†æ‹…ï¼Œè§£å†³äº†å¹¶å‘é—®é¢˜
-  å¯ä»¥é’ˆå¯¹ä¸åŒæ¨¡å—è¿›è¡Œä¼˜åŒ–
- æ–¹ä¾¿æ°´å¹³æ‰©å±•ï¼Œè´Ÿè½½å‡è¡¡ï¼Œå®¹é”™ç‡æé«˜

ç¼ºç‚¹ï¼š

 - ç³»ç»Ÿé—´ç›¸äº’ç‹¬ç«‹ï¼Œä½†æ˜¯ä¸å¯é¿å…ä¼šæœ‰ä¸€äº›ç³»ç»Ÿé—´çš„è°ƒç”¨å¸¦æ¥çš„é‡å¤å¼€å‘å·¥ä½œï¼Œå½±å“å¼€å‘æ•ˆç‡

### 3ã€åˆ†å¸ƒå¼æœåŠ¡

![](SpringCloud.assets/Snipaste_2022-04-16_12-38-13.png)

ä¼˜ç‚¹ï¼š

-  å°†åŸºç¡€æœåŠ¡è¿›è¡Œäº†æŠ½å–ï¼Œç³»ç»Ÿé—´ç›¸äº’è°ƒç”¨ï¼Œæé«˜äº†ä»£ç å¤ç”¨å’Œå¼€å‘æ•ˆç‡

ç¼ºç‚¹ï¼š

- ç³»ç»Ÿé—´è€¦åˆåº¦å˜é«˜ï¼Œè°ƒç”¨å…³ç³»é”™ç»¼å¤æ‚ï¼Œéš¾ä»¥ç»´æŠ¤

~~~
å‡ºç°äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ
	- æœåŠ¡è¶Šæ¥è¶Šå¤šï¼Œéœ€è¦ç®¡ç†æ¯ä¸ªæœåŠ¡çš„åœ°å€
	- è°ƒç”¨å…³ç³»é”™ç»¼å¤æ‚ï¼Œéš¾ä»¥ç†æ¸…ä¾èµ–å…³ç³»
	- æœåŠ¡è¿‡å¤šï¼ŒæœåŠ¡çŠ¶æ€éš¾ä»¥ç®¡ç†ï¼Œæ— æ³•æ ¹æ®æœåŠ¡æƒ…å†µåŠ¨æ€ç®¡ç†
~~~

### 4ã€æœåŠ¡æ²»ç†SOA

![](SpringCloud.assets/Snipaste_2022-04-16_12-46-13.png)

~~~
æœåŠ¡æ²»ç†è¦åšä»€ä¹ˆï¼Ÿ
	- æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œå®ç°æœåŠ¡è‡ªåŠ¨æ³¨å†Œå’Œå‘ç°ï¼Œæ— éœ€äººä¸ºè®°å½•æœåŠ¡åœ°å€
	- æœåŠ¡è‡ªåŠ¨è®¢é˜…ï¼ŒæœåŠ¡åˆ—è¡¨è‡ªåŠ¨æ¨é€ï¼ŒæœåŠ¡è°ƒç”¨é€æ˜åŒ–ï¼Œæ— éœ€å…³å¿ƒä¾èµ–å…³ç³»
	- åŠ¨æ€ç›‘æ§æœåŠ¡çŠ¶æ€ç›‘æ§æŠ¥å‘Šï¼Œäººä¸ºæ§åˆ¶æœåŠ¡çŠ¶æ€
ç¼ºç‚¹ï¼š
	- æœåŠ¡é—´ä¼šæœ‰ä¾èµ–å…³ç³»ï¼Œä¸€æ—¦æŸä¸ªç¯èŠ‚å‡ºé”™ä¼šå½±å“è¾ƒå¤§
	- æœåŠ¡å…³ç³»å¤æ‚ï¼Œè¿ç»´ã€æµ‹è¯•éƒ¨ç½²å›°éš¾ï¼Œä¸ç¬¦åˆDevOpsæ€æƒ³
~~~

### 5ã€å¾®æœåŠ¡

![](SpringCloud.assets/Snipaste_2022-04-16_12-57-23.png)

~~~
å¾®æœåŠ¡çš„ç‰¹ç‚¹ï¼š
	- å•ä¸€èŒè´£ï¼šå¾®æœåŠ¡ä¸­æ¯ä¸€ä¸ªæœåŠ¡éƒ½å¯¹åº”å”¯ä¸€çš„ä¸šåŠ¡èƒ½åŠ›ï¼Œåšåˆ°å•ä¸€èŒè´£
	- å¾®ï¼šå¾®æœåŠ¡çš„æœåŠ¡æ‹†åˆ†ç²’åº¦å¾ˆå°ï¼Œä¾‹å¦‚ä¸€ä¸ªç”¨æˆ·ç®¡ç†å°±å¯ä»¥ä½œä¸ºä¸€ä¸ªæœåŠ¡ã€‚æ¯ä¸ªæœåŠ¡è™½å°ï¼Œä½†â€œäº”è„ä¿±å…¨â€ã€‚
	- é¢å‘æœåŠ¡ï¼šé¢å‘æœåŠ¡æ˜¯è¯´æ¯ä¸ªæœåŠ¡éƒ½è¦å¯¹å¤–æš´éœ²æœåŠ¡æ¥å£APIã€‚å¹¶ä¸å…³å¿ƒæœåŠ¡çš„æŠ€æœ¯å®ç°ï¼Œåšåˆ°ä¸å¹³å°å’Œè¯­è¨€æ— å…³ï¼Œä¹Ÿä¸é™å®šç”¨ä»€ä¹ˆæŠ€æœ¯å®ç°ï¼Œåªè¦æä¾›Restçš„æ¥å£å³å¯ã€‚
	- è‡ªæ²»ï¼šè‡ªæ²»æ˜¯è¯´æœåŠ¡é—´äº’ç›¸ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°
  	- å›¢é˜Ÿç‹¬ç«‹ï¼šæ¯ä¸ªæœåŠ¡éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¼€å‘å›¢é˜Ÿï¼Œäººæ•°ä¸èƒ½è¿‡å¤šã€‚
  	- æŠ€æœ¯ç‹¬ç«‹ï¼šå› ä¸ºæ˜¯é¢å‘æœåŠ¡ï¼Œæä¾›Restæ¥å£ï¼Œä½¿ç”¨ä»€ä¹ˆæŠ€æœ¯æ²¡æœ‰åˆ«äººå¹²æ¶‰
  	- å‰åç«¯åˆ†ç¦»ï¼šé‡‡ç”¨å‰åç«¯åˆ†ç¦»å¼€å‘ï¼Œæä¾›ç»Ÿä¸€Restæ¥å£ï¼Œåç«¯ä¸ç”¨å†ä¸ºPCã€ç§»åŠ¨æ®µå¼€å‘ä¸åŒæ¥å£
  	- æ•°æ®åº“åˆ†ç¦»ï¼šæ¯ä¸ªæœåŠ¡éƒ½ä½¿ç”¨è‡ªå·±çš„æ•°æ®æº
  	- éƒ¨ç½²ç‹¬ç«‹ï¼ŒæœåŠ¡é—´è™½ç„¶æœ‰è°ƒç”¨ï¼Œä½†è¦åšåˆ°æœåŠ¡é‡å¯ä¸å½±å“å…¶å®ƒæœåŠ¡ã€‚æœ‰åˆ©äºæŒç»­é›†æˆå’ŒæŒç»­äº¤ä»˜ã€‚æ¯ä¸ªæœåŠ¡éƒ½æ˜¯ç‹¬ç«‹çš„ç»„ä»¶ï¼Œå¯å¤ç”¨ï¼Œå¯æ›¿æ¢ï¼Œé™ä½è€¦åˆï¼Œæ˜“ç»´æŠ¤
~~~

## 2.è¿œç¨‹è°ƒç”¨çš„æ–¹å¼â­ğŸ’¡

==æ— è®ºæ˜¯å¾®æœåŠ¡è¿˜æ˜¯SOAï¼Œéƒ½é¢ä¸´ç€æœåŠ¡é—´çš„è¿œç¨‹è°ƒç”¨==ã€‚é‚£ä¹ˆæœåŠ¡é—´çš„è¿œç¨‹è°ƒç”¨æ–¹å¼æœ‰å“ªäº›å‘¢ï¼Ÿ

å¸¸è§çš„è¿œç¨‹è°ƒç”¨æ–¹å¼æœ‰ä»¥ä¸‹2ç§ï¼š

- RPCï¼šRemote Produce Callè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œç±»ä¼¼çš„è¿˜æœ‰RMIï¼ˆremote method invokeï¼‰ã€‚è‡ªå®šä¹‰æ•°æ®æ ¼å¼ï¼ŒåŸºäºåŸç”ŸTCPé€šä¿¡ï¼Œ==**é€Ÿåº¦å¿«ï¼Œæ•ˆç‡é«˜**==ã€‚æ—©æœŸçš„webserviceï¼Œç°åœ¨çƒ­é—¨çš„dubboï¼Œéƒ½æ˜¯RPCçš„å…¸å‹ä»£è¡¨.

- Httpï¼šhttpå…¶å®æ˜¯ä¸€ç§ç½‘ç»œä¼ è¾“åè®®ï¼ŒåŸºäºTCPï¼Œè§„å®šäº†æ•°æ®ä¼ è¾“çš„æ ¼å¼ã€‚ç°åœ¨å®¢æˆ·ç«¯æµè§ˆå™¨ä¸æœåŠ¡ç«¯é€šä¿¡åŸºæœ¬éƒ½æ˜¯é‡‡ç”¨Httpåè®®ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥è¿›è¡Œè¿œç¨‹æœåŠ¡è°ƒç”¨ã€‚==ç¼ºç‚¹æ˜¯æ¶ˆæ¯å°è£…è‡ƒè‚¿ï¼Œä¼˜åŠ¿æ˜¯å¯¹æœåŠ¡çš„æä¾›å’Œè°ƒç”¨æ–¹æ²¡æœ‰ä»»ä½•æŠ€æœ¯é™å®šï¼Œè‡ªç”±çµæ´»ï¼Œæ›´ç¬¦åˆå¾®æœåŠ¡ç†å¿µ==ã€‚

  ç°åœ¨çƒ­é—¨çš„Resté£æ ¼ï¼Œå°±å¯ä»¥é€šè¿‡httpåè®®æ¥å®ç°ã€‚

å¦‚æœä½ ä»¬å…¬å¸å…¨éƒ¨é‡‡ç”¨JavaæŠ€æœ¯æ ˆï¼Œé‚£ä¹ˆä½¿ç”¨Dubboä½œä¸ºå¾®æœåŠ¡æ¶æ„æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚

ç›¸åï¼Œå¦‚æœå…¬å¸çš„æŠ€æœ¯æ ˆå¤šæ ·åŒ–ï¼Œè€Œä¸”ä½ æ›´é’çSpringå®¶æ—ï¼Œé‚£ä¹ˆSpringCloudæ­å»ºå¾®æœåŠ¡æ˜¯ä¸äºŒä¹‹é€‰ã€‚åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä¼š==**é€‰æ‹©SpringCloudå¥—ä»¶ï¼Œå› æ­¤æˆ‘ä»¬ä¼šä½¿ç”¨Httpæ–¹å¼æ¥å®ç°æœåŠ¡é—´è°ƒç”¨**==ã€‚

### 2.1 RestTemplateè¿œç¨‹è°ƒç”¨

Springæä¾›äº†ä¸€ä¸ª==RestTemplateæ¨¡æ¿å·¥å…·ç±»==ï¼Œå¯¹**åŸºäºHttpçš„å®¢æˆ·ç«¯è¿›è¡Œäº†å°è£…**ï¼ŒRestTemplateå°è£…äº†HttpClientã€OkHttpã€JDKåŸç”Ÿçš„URLConnectionï¼Œç›¸å½“äºä»–ä»¬çš„ä½¿ç”¨å·¥å…·ç±»ï¼Œå¹¶ä¸”**å®ç°äº†å¯¹è±¡ä¸jsonçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–**ï¼Œéå¸¸æ–¹ä¾¿ã€‚**æˆ‘ä»¬ä¼šé€šè¿‡RestTemplateè¿›è¡Œå¾®æœåŠ¡çš„æœåŠ¡é—´çš„è°ƒç”¨**ã€‚RestTemplateå¹¶æ²¡æœ‰é™å®šHttpçš„å®¢æˆ·ç«¯ç±»å‹ï¼Œè€Œæ˜¯è¿›è¡Œäº†æŠ½è±¡ï¼Œç›®å‰å¸¸ç”¨çš„3ç§éƒ½æœ‰æ”¯æŒï¼š

- HttpClient

- OkHttp

- JDKåŸç”Ÿçš„URLConnectionï¼ˆé»˜è®¤çš„ï¼‰

```java
package com.itheima.test;

import java.util.ArrayList;
import java.util.List;

import org.apache.http.NameValuePair;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.impl.client.BasicResponseHandler;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.message.BasicNameValuePair;
import org.junit.Test;
import org.springframework.web.client.RestTemplate;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.itheima.pojo.User;

public class Test01_http {
	
	private CloseableHttpClient httpClient = HttpClients.createDefault();
	
	/**
	 * httpClientå®Œæˆgetè¯·æ±‚
	 * @throws Exception
	 */
	@Test
	public void test1() throws Exception {
		HttpGet request = new HttpGet("http://localhost:8080/user/3");
		String response = this.httpClient.execute(request, new BasicResponseHandler());
		System.out.println(response);
		
	}
	
	
	/**
	 * httpClientå®Œæˆpostè¯·æ±‚
	 * @throws Exception
	 */
	@Test
	public void test2() throws Exception {
		HttpPost httpPost = new HttpPost("http://localhost:8080/user");
		//httpPost.setHeader("User-Agent","Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36");
		/*
		 * postå¸¦å‚æ•°å¼€å§‹
		 */
		// ç¬¬ä¸€æ­¥ï¼šæ„é€ listé›†åˆï¼Œå¾€é‡Œé¢ä¸¢æ•°æ®
		List<NameValuePair> list = new ArrayList<NameValuePair>();
		BasicNameValuePair basicNameValuePair1 = new BasicNameValuePair("username", "xiaoyaya");
		BasicNameValuePair basicNameValuePair2 = new BasicNameValuePair("password", "666666");
		list.add(basicNameValuePair1);
		list.add(basicNameValuePair2);
		// ç¬¬äºŒæ­¥ï¼šæˆ‘ä»¬å‘ç°Entityæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ‰€ä»¥åªèƒ½æ‰¾å®ç°ç±»ï¼Œå‘ç°å®ç°ç±»åˆéœ€è¦ä¸€ä¸ªé›†åˆï¼Œé›†åˆçš„æ³›å‹æ˜¯NameValuePairç±»å‹
		UrlEncodedFormEntity formEntity = new UrlEncodedFormEntity(list);
		// ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡setEntity å°†æˆ‘ä»¬çš„entityå¯¹è±¡ä¼ é€’è¿‡å»
		httpPost.setEntity(formEntity);
		
		
		//æ‰§è¡Œè¯·æ±‚
		String response = this.httpClient.execute(httpPost, new BasicResponseHandler());
		System.out.println(response);
		
	}
	
	/**
	 * è¿”å›å­—ç¬¦ä¸²è½¬æˆå¯¹è±¡
	 * @throws Exception
	 */
	@Test
	public void test3() throws Exception {
		HttpGet request = new HttpGet("http://localhost:8080/user/3");
		String response = this.httpClient.execute(request, new BasicResponseHandler());
		System.out.println(response);
		
		System.out.println("å­—ç¬¦ä¸²è½¬æˆå¯¹è±¡ã€‚ã€‚ã€‚ã€‚ã€‚");
		ObjectMapper om = new ObjectMapper();
		User user = om.readValue(response, User.class);
		System.out.println(user);
		System.out.println(user.getName());
		
	}	
	
	/**
	 * 2.Springä¸­çš„RestTemplateå®Œæˆè°ƒç”¨
	 * @throws Exception
	 */
	@Test
	public void test4() throws Exception {
		RestTemplate rt = new RestTemplate();
		User usr = rt.getForObject("http://localhost:8080/user/3", User.class);
		System.out.println(usr);		
	}
}
```

## 3.SpringCloudä»‹ç»â­

SpringCloudæ˜¯Springæ——ä¸‹çš„é¡¹ç›®ä¹‹ä¸€ï¼Œ[å®˜ç½‘åœ°å€ï¼šhttp://projects.spring.io/spring-cloud/](http://projects.spring.io/spring-cloud/)

Springæœ€æ“…é•¿çš„å°±æ˜¯é›†æˆï¼ŒæŠŠä¸–ç•Œä¸Šæœ€å¥½çš„æ¡†æ¶æ‹¿è¿‡æ¥ï¼Œé›†æˆåˆ°è‡ªå·±çš„é¡¹ç›®ä¸­ã€‚

SpringCloudä¹Ÿæ˜¯ä¸€æ ·ï¼Œå®ƒå°†ç°åœ¨éå¸¸æµè¡Œçš„ä¸€äº›æŠ€æœ¯æ•´åˆåˆ°ä¸€èµ·ï¼Œå®ç°äº†è¯¸å¦‚ï¼šé…ç½®ç®¡ç†ï¼ŒæœåŠ¡å‘ç°ï¼Œæ™ºèƒ½è·¯ç”±ï¼Œè´Ÿè½½å‡è¡¡ï¼Œç†”æ–­å™¨ï¼Œæ§åˆ¶æ€»çº¿ï¼Œé›†ç¾¤çŠ¶æ€ç­‰ç­‰åŠŸèƒ½ã€‚å…¶ä¸»è¦æ¶‰åŠçš„ç»„ä»¶åŒ…æ‹¬ï¼š

Netflixå…¬å¸æ——ä¸‹çš„ä¸€äº›å¼€æºç»„ä»¶ï¼š

- Eurekaï¼šæ³¨å†Œä¸­å¿ƒ --> consul , zookeeper 
- Zuulï¼šæœåŠ¡ç½‘å…³ 
- Ribbonï¼šè´Ÿè½½å‡è¡¡
- Feignï¼šæœåŠ¡è°ƒç”¨
- Hystixï¼šç†”æ–­å™¨

ä»¥ä¸Šåªæ˜¯å…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œæ¶æ„å›¾ï¼š

![](SpringCloud.assets/Snipaste_2022-04-16_17-52-28.png)

**SpringCloudçš„ç‰ˆæœ¬**

SpringCloudçš„ç‰ˆæœ¬å‘½åæ¯”è¾ƒç‰¹æ®Šï¼Œå› ä¸ºå®ƒä¸æ˜¯ä¸€ä¸ªç»„ä»¶ï¼Œè€Œæ˜¯è®¸å¤šç»„ä»¶çš„é›†åˆï¼Œå®ƒçš„å‘½åæ˜¯ä»¥Aåˆ°Zçš„ä¸ºé¦–å­—æ¯çš„ä¸€äº›å•è¯ï¼ˆå…¶å®æ˜¯ä¼¦æ•¦åœ°é“ç«™çš„åå­—ï¼‰ç»„æˆ,ä¸è¿‡ä»2020å¼€å§‹ï¼ŒSpringCloudé‡æ–°ä»¥å¹´ä»½å¼€å§‹å®šä¹‰ç‰ˆæœ¬åï¼š

![](SpringCloud.assets/Snipaste_2022-04-16_18-02-06.png)

æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ï¼Œä¼šæ˜¯ä»¥Finchleyçš„ç‰ˆæœ¬ã€‚

å…¶ä¸­åŒ…å«çš„ç»„ä»¶ï¼Œä¹Ÿéƒ½æœ‰å„è‡ªçš„ç‰ˆæœ¬ï¼Œå¦‚ä¸‹è¡¨ï¼š

| Component                 | Edgware.SR4    | Finchley.SR1  | Finchley.BUILD-SNAPSHOT |
| ------------------------- | -------------- | ------------- | ----------------------- |
| spring-cloud-aws          | 1.2.3.RELEASE  | 2.0.0.RELEASE | 2.0.1.BUILD-SNAPSHOT    |
| spring-cloud-bus          | 1.3.3.RELEASE  | 2.0.0.RELEASE | 2.0.1.BUILD-SNAPSHOT    |
| spring-cloud-cli          | 1.4.1.RELEASE  | 2.0.0.RELEASE | 2.0.1.BUILD-SNAPSHOT    |
| spring-cloud-commons      | 1.3.4.RELEASE  | 2.0.1.RELEASE | 2.0.2.BUILD-SNAPSHOT    |
| spring-cloud-contract     | 1.2.5.RELEASE  | 2.0.1.RELEASE | 2.0.2.BUILD-SNAPSHOT    |
| spring-cloud-config       | 1.4.4.RELEASE  | 2.0.1.RELEASE | 2.0.2.BUILD-SNAPSHOT    |
| spring-cloud-netflix      | 1.4.5.RELEASE  | 2.0.1.RELEASE | 2.0.2.BUILD-SNAPSHOT    |
| spring-cloud-security     | 1.2.3.RELEASE  | 2.0.0.RELEASE | 2.0.1.BUILD-SNAPSHOT    |
| spring-cloud-cloudfoundry | 1.1.2.RELEASE  | 2.0.0.RELEASE | 2.0.1.BUILD-SNAPSHOT    |
| spring-cloud-consul       | 1.3.4.RELEASE  | 2.0.1.RELEASE | 2.0.2.BUILD-SNAPSHOT    |
| spring-cloud-sleuth       | 1.3.4.RELEASE  | 2.0.1.RELEASE | 2.0.2.BUILD-SNAPSHOT    |
| spring-cloud-stream       | Ditmars.SR4    | Elmhurst.SR1  | Elmhurst.BUILD-SNAPSHOT |
| spring-cloud-zookeeper    | 1.2.2.RELEASE  | 2.0.0.RELEASE | 2.0.1.BUILD-SNAPSHOT    |
| spring-boot               | 1.5.14.RELEASE | 2.0.4.RELEASE | 2.0.4.BUILD-SNAPSHOT    |
| spring-cloud-task         | 1.2.3.RELEASE  | 2.0.0.RELEASE | 2.0.1.BUILD-SNAPSHOT    |
| spring-cloud-vault        | 1.1.1.RELEASE  | 2.0.1.RELEASE | 2.0.2.BUILD-SNAPSHOT    |
| spring-cloud-gateway      | 1.0.2.RELEASE  | 2.0.1.RELEASE | 2.0.2.BUILD-SNAPSHOT    |
| spring-cloud-openfeign    |                | 2.0.1.RELEASE | 2.0.2.BUILD-SNAPSHOT    |
| spring-cloud-function     | 1.0.0.RELEASE  | 1.0.0.RELEASE | 1.0.1.BUILD-SNAPSHOT    |

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä¸€ä¸€å­¦ä¹ SpringCloudä¸­çš„é‡è¦ç»„ä»¶ã€‚

## 4.Eurekaç»„ä»¶â­ğŸ’¡

### 4.1 Eurekaå…¥é—¨æ¡ˆä¾‹æ­å»º

-==åœºæ™¯ä»‹ç»ï¼š==

```
ä¸»è¦è§’è‰²ï¼š
	- æœåŠ¡æä¾›è€…: æä¾›æ•°æ®çš„ä¸€æ–¹ï¼Œç”¨æˆ·æä¾›è€…æŸ¥è¯¢æ•°æ®åº“æ•°æ®ï¼Œåœ¨æ¥å£è¿”å›
	- æœåŠ¡æ¶ˆè´¹è€…: è·å–æ•°æ®çš„ä¸€æ–¹ï¼Œè°ƒç”¨æä¾›è€…é¡¹ç›®ï¼Œè·å–ç”¨æˆ·æ•°æ®
```

==æ€è·¯å›¾ï¼š==

![](SpringCloud.assets/Snipaste_2022-04-16_18-23-15.png)

#### 4.1.1æ­å»ºæœåŠ¡æä¾›è€…

æœåŠ¡æä¾›æ–¹é»˜è®¤8081ç«¯å£ã€‚

æœåŠ¡æä¾›è€…çš„æ­å»ºæ­¥éª¤å¦‚ä¸‹ï¼š

- 1ã€åˆ›å»ºå·¥ç¨‹å¯¼å…¥èµ·æ­¥ä¾èµ–ï¼šwebã€SpringDataJpaã€mysqlé©±åŠ¨
- 2ã€å‡†å¤‡å¥½æ•°æ®åº“è¡¨å’Œç”¨æˆ·å®ä½“ç±»
- 3ã€ç¼–å†™SpringDataJpaè§„èŒƒçš„Daoæ¥å£
- 4ã€ç¼–å†™Serviceå±‚ä¸šåŠ¡ç±»
- 5ã€ç¼–å†™Controller
- 6ã€ç¼–å†™application.ymlé…ç½®æ–‡ä»¶
- 7ã€ç¼–å†™å¯åŠ¨ç±»ã€å¼•å¯¼ç±»ã€‘
- 8ã€å¯åŠ¨å¹¶æµ‹è¯•æ¥å£

~~~xml
<project xmlns="http://maven.apache.org/POM/4.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<groupId>com.atguigu</groupId>
	<artifactId>springcloud-provider</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>2.0.1.RELEASE</version>
		<relativePath />
	</parent>

	<properties>
		<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
		<project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
		<java.version>1.8</java.version>
	</properties>

	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>
		<dependency>
			<groupId>mysql</groupId>
			<artifactId>mysql-connector-java</artifactId>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>
	</dependencies>

</project>
~~~

~~~mysql
CREATE TABLE user_info (
  `user_Id` int(11) NOT NULL DEFAULT '0',
  `name` varchar(255) DEFAULT NULL,
  `password` varchar(255) DEFAULT NULL,
  `user_Name` varchar(50) DEFAULT NULL,
  PRIMARY KEY (`user_Id`)
)

INSERT INTO user_info
(user_Id, name, password, user_Name)
VALUES(2, 'heheda', '123456', 'éƒ¨è½é‡Œæ— æ•Œå…¬å¸');
~~~

**pojo**

~~~java
package com.atguigu.pojo;

import java.io.Serializable;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;

/**
   * ç”¨æˆ·å®ä½“ç±»
 * @author Admin
 *
 */
@Entity
@Table(name="user_info")
public class User implements Serializable{
	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	@Column(name ="user_Id")
	private Integer id;
	
	@Column(name="user_Name") 
	private String userName;
	
	@Column(name="password")
	private String password;
	
	@Column(name="name")
	private String name;

	public Integer getId() {
		return id;
	}

	public void setId(Integer id) {
		this.id = id;
	}

	

	public String getUserName() {
		return userName;
	}

	public void setUserName(String userName) {
		this.userName = userName;
	}

	public String getPassword() {
		return password;
	}

	public void setPassword(String password) {
		this.password = password;
	}

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}

	@Override
	public String toString() {
		return "User [id=" + id + ", username=" + userName + ", password=" + password + ", name=" + name + "]";
	}
}
~~~

**dao**

~~~java
package com.atguigu.dao;

import org.springframework.data.jpa.repository.JpaRepository;

import com.atguigu.pojo.User;
/**
 * daoæ¥å£
 * @author Admin
 *
 */
public interface UserDao extends JpaRepository<User, Integer>{
}
~~~

**service**

~~~java
package com.atguigu.service;

import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.atguigu.dao.UserDao;
import com.atguigu.pojo.User;

@Component
public class UserService {
	@Autowired
	private UserDao userDao;
	
    public User findById(Integer id) {
    	Optional<User> optional = userDao.findById(id);
    	return optional.get();
    }
}
~~~

**controller**

~~~java
package com.atguigu.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;

import com.atguigu.pojo.User;
import com.atguigu.service.UserService;

/**
 *    æ§åˆ¶å™¨
 * @author Admin
 *
 */
@RestController
public class UserController {
	@Autowired
	private UserService userService;
	
	@GetMapping("/user/{id}")
    public User findById(@PathVariable Integer id) {
    	return userService.findById(id);
    }
}
~~~

**é…ç½®æ–‡ä»¶**

~~~yaml
# ç«¯å£
server:
  port: 8081

# æ•°æ®æº
spring:
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/test
    username: root
    password: 123456
  jpa:
    show-sql: true
~~~

**å¯åŠ¨ç±»**

~~~java
package com.atguigu;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class ProviderApplication {
	public static void main(String[] args) {
		SpringApplication.run(ProviderApplication.class, args);
	}

}
~~~

#### 4.1.2 æ­å»ºæœåŠ¡æ¶ˆè´¹è€…

æœåŠ¡æ¶ˆè´¹æ–¹é»˜è®¤8080ç«¯å£

==**æ­å»ºæœåŠ¡æ¶ˆè´¹è€…æ­¥éª¤ï¼š**==

- 1ã€åˆ›å»ºå·¥ç¨‹å¹¶å¯¼å…¥ä¾èµ–ï¼šweb
- 2ã€ç¼–å†™å¯åŠ¨ç±»ï¼Œå¹¶åœ¨å¯åŠ¨ç±»ä¸­é…ç½®RestTemplate
- 3ã€ç¼–å†™Controllerï¼š è°ƒç”¨æœåŠ¡æä¾›è€…æ¥å£

- 4ã€å¯åŠ¨å¹¶æµ‹è¯•

~~~xml
<project xmlns="http://maven.apache.org/POM/4.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<groupId>com.atguigu</groupId>
	<artifactId>springcloud-consumer</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>2.0.1.RELEASE</version>
		<relativePath />
	</parent>

	<properties>
		<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
		<project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
		<java.version>1.8</java.version>
	</properties>

	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>
	</dependencies>
</project>
~~~

**controller**

~~~java
package com.atguigu.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

@RestController
public class ConsumerController {
	@Autowired
	private RestTemplate restTemplate;
	
	@GetMapping("/consumer/{id}")
    public String consumer(@PathVariable Integer id) {
    	String urlString = "http://localhost:8081/user/"+id;
        
    	// è¿œç¨‹è°ƒç”¨
    	String user = restTemplate.getForObject(urlString, String.class);
        return user;
	}
}

~~~

**å¯åŠ¨ç±»**

~~~java
package com.atguigu;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;
import org.springframework.web.client.RestTemplate;

@SpringBootApplication
public class ConsumerApplication {
	public static void main(String[] args) {
		SpringApplication.run(ConsumerApplication.class, args);
	}
	
	// åˆ›å»ºä¸€ä¸ªRestæ¨¡æ¿
	@Bean
	public RestTemplate restTemplate() {
		return  new RestTemplate();
	}

}
~~~

![](SpringCloud.assets/Snipaste_2022-04-17_00-06-53.png)

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥è¿›è¡ŒåŸºæœ¬çš„è¿œç¨‹è°ƒç”¨å•¦ã€‚

### 4.2æ³¨å†Œä¸­å¿ƒEurekaçš„å¼•å…¥å’Œæ­å»ºâ­ğŸ’¡

ä¸Šä¸€æ­¥æ­å»ºçš„å¾®æœåŠ¡åœºæ™¯å‡ºç°çš„é—®é¢˜ï¼š

```
- åœ¨consumerä¸­ï¼Œæˆ‘ä»¬æŠŠurlåœ°å€ç¡¬ç¼–ç åˆ°äº†ä»£ç ä¸­ï¼Œä¸æ–¹ä¾¿åæœŸç»´æŠ¤
- consumeréœ€è¦è®°å¿†user-serviceçš„åœ°å€ï¼Œå¦‚æœå‡ºç°å˜æ›´ï¼Œå¯èƒ½å¾—ä¸åˆ°é€šçŸ¥ï¼Œåœ°å€å°†å¤±æ•ˆ
- consumerä¸æ¸…æ¥šuser-serviceçš„çŠ¶æ€ï¼ŒæœåŠ¡å®•æœºä¹Ÿä¸çŸ¥é“
- user-serviceåªæœ‰1å°æœåŠ¡ï¼Œä¸å…·å¤‡é«˜å¯ç”¨æ€§
- å³ä¾¿user-serviceå½¢æˆé›†ç¾¤ï¼Œconsumerè¿˜éœ€è‡ªå·±å®ç°è´Ÿè½½å‡è¡¡
```

![1562416196698](SpringCloud.assets/1562416196698.png) 

renewalï¼šç»­çº¦

- ==Eureka-Server==ï¼šå°±æ˜¯æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼ˆå¯ä»¥æ˜¯ä¸€ä¸ªé›†ç¾¤ï¼‰ï¼Œå¯¹å¤–æš´éœ²è‡ªå·±çš„åœ°å€ã€‚
- ==æä¾›è€…==ï¼šå¯åŠ¨åå‘Eurekaæ³¨å†Œè‡ªå·±ä¿¡æ¯ï¼ˆåœ°å€ï¼ŒæœåŠ¡åç§°ç­‰ï¼‰ï¼Œå¹¶ä¸”å®šæœŸè¿›è¡ŒæœåŠ¡ç»­çº¦
- ==æ¶ˆè´¹è€…==ï¼šæœåŠ¡è°ƒç”¨æ–¹ï¼Œä¼šå®šæœŸå»Eurekaæ‹‰å–æœåŠ¡åˆ—è¡¨ï¼Œç„¶åä½¿ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•é€‰å‡ºä¸€ä¸ªæœåŠ¡è¿›è¡Œè°ƒç”¨ã€‚
- ==å¿ƒè·³(ç»­çº¦)==ï¼šæä¾›è€…å®šæœŸé€šè¿‡httpæ–¹å¼å‘Eurekaåˆ·æ–°è‡ªå·±çš„çŠ¶æ€

æˆ‘ä»¬ä¸‹é¢æ¥æ­å»º==Eureke-serveræœåŠ¡æ³¨å†Œä¸­å¿ƒå·¥ç¨‹==ã€‚

####  4.2.1 Eureke-serverå·¥ç¨‹æ­å»º

<img src="SpringCloud.assets/Snipaste_2022-04-17_00-20-06.png" style="zoom:75%;" />



**ä¾èµ–**

åœ¨å¯¼å…¥ä¾èµ–åæ ‡çš„æ—¶å€™1ï¼Œç”±äºå¯èƒ½é˜¿é‡Œäº‘æ²¡æœ‰è¿™ä¸ªjar,æ‰€ä»¥è¦å…ˆå°†é˜¿é‡Œäº‘è¿œç¨‹ä»“åº“åœ°å€æ³¨é‡Šæ‰ã€‚

~~~xml
<project xmlns="http://maven.apache.org/POM/4.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<groupId>com.atguigu</groupId>
	<artifactId>eureka</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>2.0.1.RELEASE</version>
		<relativePath />
	</parent>

	<properties>
		<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
		<project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
		<java.version>1.8</java.version>
		<!-- SpringCloudç‰ˆæœ¬ï¼ŒFç³»åˆ— -->
		<spring-cloud.version>Finchley.RC1</spring-cloud.version>
	</properties>

	<dependencies>
		<!-- EurekaæœåŠ¡ç«¯ -->
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
		</dependency>
	</dependencies>

	<dependencyManagement>
		<dependencies>
			<!-- SpringCloudä¾èµ–ï¼Œä¸€å®šè¦æ”¾åˆ°dependencyManagementä¸­ï¼Œèµ·åˆ°ç®¡ç†ç‰ˆæœ¬çš„ä½œç”¨å³å¯ -->
			<dependency>
				<groupId>org.springframework.cloud</groupId>
				<artifactId>spring-cloud-dependencies</artifactId>
				<version>${spring-cloud.version}</version>
				<type>pom</type>
				<scope>import</scope>
			</dependency>
		</dependencies>
	</dependencyManagement>

	<repositories>
		<repository>
			<id>spring-milestones</id>
			<name>Spring Milestones</name>
			<url>https://repo.spring.io/milestone</url>
			<snapshots>
				<enabled>false</enabled>
			</snapshots>
		</repository>
	</repositories>

</project>
~~~

ç¼–å†™å¼•å¯¼ç±»ï¼Œ==éœ€è¦åŠ ä¸Š@EnableEurekaServeræ³¨è§£ï¼Œ==**è¿™ä¸ªæ³¨è§£ç”¨æ¥æ ‡è®°å½“å‰å·¥ç¨‹æ˜¯EurekaæœåŠ¡å™¨çš„æœåŠ¡ç«¯**

~~~java
package com.atguigu;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

@SpringBootApplication
@EnableEurekaServer  // å¼€å¯æ³¨å†Œä¸­å¿ƒæœåŠ¡
public class EurekaAppliation {
	public static void main(String[] args) {
		SpringApplication.run(EurekaAppliation.class, args);
	}

}
~~~

**é…ç½®æ–‡ä»¶**

~~~yaml
server:
  port: 10086
~~~

æ­¤æ—¶ï¼Œæˆ‘ä»¬è®¿é—®http://localhost:10086/ï¼Œå¯ä»¥çœ‹åˆ°ï¼ŒeurekaæœåŠ¡ç«¯å¼€å¯ï¼š

![](SpringCloud.assets/Snipaste_2022-04-17_11-29-13.png)

#### 4.2.2 è§£å†³EurekaServerå·¥ç¨‹æŠ¥é”™é—®é¢˜

åˆšæ‰æˆ‘ä»¬è®¿é—®http://localhost:10086/ï¼Œå¯ä»¥çœ‹åˆ°EurekaæœåŠ¡ç«¯å·²ç»å¯åŠ¨æˆåŠŸï¼Œä½†æ˜¯æˆ‘ä»¬æŸ¥çœ‹åå°æ—¥å¿—ï¼Œå‘ç°åå°æ—¥å¿—ä¸€ç›´åœ¨é‡å¤æŠ¥é”™ï¼

![](SpringCloud.assets/Snipaste_2022-04-17_19-12-54.png)

æŸ¥çœ‹æˆ‘ä»¬å¯¼å…¥çš„pomä¾èµ–ï¼Œå¯ä»¥çœ‹åˆ°ï¼š

![](SpringCloud.assets/Snipaste_2022-04-17_19-16-00.png)

**åŸå› å¦‚ä¸‹**ï¼š

- 1.EurekaServeræœåŠ¡ç«¯é‡Œé¢å†…ç½®äº†ä¸€ä¸ªEurekaClientå®¢æˆ·ç«¯ï¼Œè€Œå®¢æˆ·ç«¯ç¨‹åºå®é™…ä¸Šéœ€è¦æ³¨å†Œåˆ°æœåŠ¡ç«¯ï¼Œå¹¶ä¸”EurekaServeræœåŠ¡ç«¯æœ‰ä¸€ä¸ªé»˜è®¤ç«¯å£==8761==ï¼Œç”±äºæˆ‘ä»¬ä¿®æ”¹äº†ç«¯å£å·ï¼Œå¯¼è‡´å®¢æˆ·ç«¯æ‰¾ä¸åˆ°æœåŠ¡ç«¯è€Œè¿æ¥ä¸ä¸Šã€‚
- 2.ä¹‹æ‰€ä»¥ä¼šæœ‰å®¢æˆ·ç«¯ï¼Œæ˜¯å› ä¸º==æ³¨å†Œä¸­å¿ƒéœ€è¦è€ƒè™‘åˆ°é›†ç¾¤é«˜å¯ç”¨==ï¼Œè¿™å°±æ„å‘³ç€**æ³¨å†Œä¸­å¿ƒå½¼æ­¤ä¹‹é—´éœ€è¦ç›¸äº’æ³¨å†Œ**ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯æœåŠ¡ç«¯çš„åœ°å€ï¼Œè¿™æ ·å°±å¯ä»¥æ³¨å†ŒæˆåŠŸï¼

~~~yaml
server:
  port: 10086
  
#é…ç½®æœåŠ¡ID
spring:
  application:
    name: eureka-server   # ä¸è¦å¤§å†™å’Œä¸‹åˆ’çº¿
    
# é…ç½®Eurekaå®¢æˆ·ç«¯ï¼š
eureka:
  client:
    service-url:
      defaultZone: http://localhost:10086/eureka/   #å‘Šè¯‰ç°åœ¨Eurekaå®¢æˆ·ç«¯çœŸæ­£çš„æ³¨å†Œä¸­å¿ƒçš„åœ°å€
      
~~~

![](SpringCloud.assets/Snipaste_2022-04-17_20-20-10.png)

è™½ç„¶é…ç½®è¿™æ ·ä»¥åã€‚å¯ä»¥æ³¨å†ŒæˆåŠŸï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šå‡ºç°ä¸€æ¬¡è¿™ä¸ªé”™è¯¯ï¼Œè¿™æ˜¯å› ä¸ºï¼š

>å½“æœåŠ¡åˆå§‹åŒ–çš„æ—¶å€™ï¼Œserverè¿˜æ²¡æœ‰å‡†å¤‡ï¼Œè¿™æ—¶å€™clienté©¬ä¸Šæ³¨å†Œåˆ°serverç«¯ï¼Œæ‰€ä»¥å°±æŠ¥é”™
>åé¢å½“æœåŠ¡ç«¯å¯åŠ¨å®Œæˆä¹‹åï¼Œå®¢æˆ·ç«¯å°±èƒ½æ­£å¸¸å’ŒæœåŠ¡ç«¯é€šä¿¡

ä¸ºäº†å½»åº•è§£å†³è¿™ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç»§ç»­ä¿®æ”¹é…ç½®ï¼Œä½†æ˜¯åé¢æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šè¿™æ ·é…ï¼Œå› ä¸ºè¿™æ ·é…ç½®ç´¢ç„¶åå°ä¸æŠ¥é”™ï¼Œä½†æ˜¯è‡ªå·±ä¹Ÿä¸ä¼šæ³¨å†Œè‡ªå·±ã€‚è¿™é‡Œåªæ˜¯è¯´æ˜æ¼”ç¤ºä¸€ä¸‹ï¼š

~~~yaml
server:
  port: 10086
#é…ç½®æœåŠ¡id
spring:
  application:
    name: eureka-server   # ä¸è¦å¤§å†™å’Œä¸‹åˆ’çº¿
#é…ç½®eurekaå®¢æˆ·ç«¯é…ç½®
eureka:
  client:
    register-with-eureka: false  # ä¸è®©å½“å‰æœåŠ¡æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ
    fetch-registry: false #ä¸æ‹‰å–æ³¨å†Œä¿¡æ¯
    service-url:
      defaultZone: http://localhost:10086/eureka/  #å‘Šè¯‰ç°åœ¨çœŸæ­£çš„æ³¨å†Œä¸­å¿ƒçš„åœ°å€
~~~

### 4.3 æœåŠ¡æ³¨å†Œâ­ğŸ’¡

æœ‰äº†æ³¨å†Œä¸­å¿ƒä»¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾€æ³¨å†Œä¸­å¿ƒä¸­æ³¨å†ŒæœåŠ¡å•¦ã€‚

==**æœåŠ¡æ³¨å†Œçš„æ­¥éª¤å¦‚ä¸‹**==ï¼š

- å¯¼å…¥EurekaClientèµ·æ­¥ä¾èµ–
- åœ¨å¯åŠ¨ç±»ä¸­å¯ç”¨EurekaClientçš„ä½¿ç”¨
- åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®EurekaæœåŠ¡ç«¯çš„åœ°å€
- æŸ¥çœ‹æœåŠ¡åˆ—è¡¨

**å¯¼å…¥EurekaClientèµ·æ­¥ä¾èµ–**

~~~xml
<project xmlns="http://maven.apache.org/POM/4.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<groupId>com.atguigu</groupId>
	<artifactId>springcloud-provider</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>2.0.1.RELEASE</version>
		<relativePath />
	</parent>

	<properties>
		<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
		<project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
		<java.version>1.8</java.version>
	</properties>


	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-jpa</artifactId>
		</dependency>
		<dependency>
			<groupId>mysql</groupId>
			<artifactId>mysql-connector-java</artifactId>
			<scope>runtime</scope>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>
		<!-- Eurekaå®¢æˆ·ç«¯ -->
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
		</dependency>
	</dependencies>

	<!-- SpringCloudçš„ä¾èµ– -->
	<dependencyManagement>
		<dependencies>
			<dependency>
				<groupId>org.springframework.cloud</groupId>
				<artifactId>spring-cloud-dependencies</artifactId>
				<version>Finchley.RC1</version>
				<type>pom</type>
				<scope>import</scope>
			</dependency>
		</dependencies>
	</dependencyManagement>
	<!-- Springçš„ä»“åº“åœ°å€ -->
	<repositories>
		<repository>
			<id>spring-milestones</id>
			<name>Spring Milestones</name>
			<url>https://repo.spring.io/milestone</url>
			<snapshots>
				<enabled>false</enabled>
			</snapshots>
		</repository>
	</repositories>
</project>
~~~

****

**åœ¨å¯åŠ¨ç±»ä¸­å¯ç”¨EurekaClientçš„ä½¿ç”¨**

~~~java
package com.atguigu;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;

@SpringBootApplication
// @EnableEurekaClient   ç”±äºè¿™ä¸ªæ³¨è§£ä»£è¡¨æ˜¯åªèƒ½æ³¨å†Œåˆ°EurekaæœåŠ¡ç«¯ï¼Œé™å®šåªèƒ½ç”¨eurekaï¼Œä½†æ˜¯æ³¨å†Œä¸­å¿ƒå¯èƒ½ä¸ä»…ä»…æ˜¯EUREKAï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ä¸‹é¢è¿™ä¸ªæ³¨è§£
@EnableDiscoveryClient // ä¸€èˆ¬ç”¨è¿™ä¸ªï¼ŒæœåŠ¡å‘ç°
public class ProviderApplication {
	public static void main(String[] args) {
		SpringApplication.run(ProviderApplication.class, args);
	}

}
~~~

****

**åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®EurekaæœåŠ¡ç«¯çš„åœ°å€**

~~~yaml
spring:
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/test
    username: root
    password: 123456
  jpa:
    show-sql: true
  application:
    name: user-service #å®šä¹‰æœåŠ¡ID
 
#eureké…ç½®
eureka:
  client:
    service-url:
      defaultZone: http://localhost:10086/eureka/
~~~

å¯ä»¥çœ‹åˆ°ï¼ŒæœåŠ¡æä¾›è€…å·²ç»è¢«æ³¨å†ŒæˆåŠŸå•¦

![](SpringCloud.assets/Snipaste_2022-04-23_11-27-56.png)

### 4.4 æœåŠ¡æ‹‰å–â­ğŸ’¡

æˆ‘ä»¬çš„æœåŠ¡æä¾›æ–¹å¾®æœåŠ¡æ³¨å†Œä»¥åï¼Œæˆ‘ä»¬çš„æœåŠ¡æ¶ˆè´¹æ–¹å°±å¯ä»¥å»æ³¨å†Œä¸­å¿ƒæ‹‰å–å·²ç»æ³¨å†Œçš„å¾®æœåŠ¡ã€‚

==æ­¥éª¤å¦‚ä¸‹ï¼š==

- å¯¼å…¥EurekaClientèµ·æ­¥ä¾èµ–
- åœ¨å¯åŠ¨ç±»ä¸­å¯ç”¨EurekaClientçš„ä½¿ç”¨
- åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®EurekaæœåŠ¡ç«¯çš„åœ°å€
- åœ¨Controllerä¸­æ³¨å…¥**DiscoveryClient**æ‹‰å–æœåŠ¡æä¾›æ–¹çš„IPå’Œç«¯å£ã€‚
- é‡å¯æµ‹è¯•

**å¯¼å…¥EurekaClientèµ·æ­¥ä¾èµ–**

~~~xml
<project xmlns="http://maven.apache.org/POM/4.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<groupId>com.atguigu</groupId>
	<artifactId>springcloud-consumer</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>2.0.1.RELEASE</version>
		<relativePath />
	</parent>

	<properties>
		<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
		<project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
		<java.version>1.8</java.version>
	</properties>

	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>
		<!-- Eurekaå®¢æˆ·ç«¯ -->
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
		</dependency>
	</dependencies>

	<!-- SpringCloudçš„ä¾èµ– -->
	<dependencyManagement>
		<dependencies>
			<dependency>
				<groupId>org.springframework.cloud</groupId>
				<artifactId>spring-cloud-dependencies</artifactId>
				<version>Finchley.RC1</version>
				<type>pom</type>
				<scope>import</scope>
			</dependency>
		</dependencies>
	</dependencyManagement>
	<!-- Springçš„ä»“åº“åœ°å€ -->
	<repositories>
		<repository>
			<id>spring-milestones</id>
			<name>Spring Milestones</name>
			<url>https://repo.spring.io/milestone</url>
			<snapshots>
				<enabled>false</enabled>
			</snapshots>
		</repository>
	</repositories>
</project>
~~~

**åœ¨å¯åŠ¨ç±»ä¸­å¯ç”¨EurekaClientçš„ä½¿ç”¨**

~~~java
package com.atguigu;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.context.annotation.Bean;
import org.springframework.web.client.RestTemplate;

@SpringBootApplication
@EnableDiscoveryClient
public class ConsumerApplication {
	public static void main(String[] args) {
		SpringApplication.run(ConsumerApplication.class, args);
	}
	
	// åˆ›å»ºä¸€ä¸ªRestæ¨¡æ¿
	@Bean
	public RestTemplate restTemplate() {
		return  new RestTemplate();
	}

}
~~~

****

**åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®EurekaæœåŠ¡ç«¯çš„åœ°å€**

~~~yaml
# ç«¯å£
server:
  port: 8080

# æ•°æ®æº
spring:
  application:
    name: user-consumer #å®šä¹‰æœåŠ¡ID
 
#eureké…ç½®
eureka:
  client:
    service-url:
      defaultZone: http://localhost:10086/eureka/
      
~~~

****

**åœ¨Controllerä¸­æ³¨å…¥**DiscoveryClient**æ‹‰å–æœåŠ¡æä¾›æ–¹çš„IPå’Œç«¯å£**

~~~java
package com.atguigu.controller;

import java.util.List;
import java.util.Random;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.client.discovery.DiscoveryClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

@RestController
public class ConsumerController {
	@Autowired
	private RestTemplate restTemplate;
	
	@Autowired
	private DiscoveryClient DiscoveryClient;
	
	@GetMapping("/consumer/{id}")
    public String consumer(@PathVariable Integer id) {
		// 1.é€šè¿‡æ¥å£è·å–IPå’Œç«¯å£ä¿¡æ¯
		List<ServiceInstance> instances = DiscoveryClient.getInstances("USER-SERVICE");
		
		/*
		 * è¿”å›çš„listé›†åˆå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬ä½¿ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•ï¼šéšæœºã€è½®è¯¢ã€å“ˆå¸Œã€æƒé‡
		  instances.get(new Random().nextInt(instances.size()));
		*/
		
		// 2.æˆ‘ä»¬ç°åœ¨åªæœ‰ä¸€ä¸ªæœåŠ¡æä¾›æ–¹ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥è·å–ç¬¬ä¸€ä¸ªå°±å¯ä»¥å•¦
		ServiceInstance serviceInstance = instances.get(0);
		String host = serviceInstance.getHost();
		int port = serviceInstance.getPort();
		
		
    	String urlString = "http://"+host+":"+port+"/user/"+id;
    	// è¿œç¨‹è°ƒç”¨
    	String user = restTemplate.getForObject(urlString, String.class);
        return user;
	}
	
	
	
	/*
	 * è¿™æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€ç§æ“ä½œæ–¹å¼
	* 
	* 
	@Autowired
	private RestTemplate restTemplate;
	
	@GetMapping("/consumer/{id}")
    public String consumer(@PathVariable Integer id) {
    	String urlString = "http://localhost:8081/user/"+id;
    	// è¿œç¨‹è°ƒç”¨
    	String user = restTemplate.getForObject(urlString, String.class);
        return user;
	}
	
	*/
}
~~~

### 4.5 æ³¨å†Œä¸­å¿ƒçš„é«˜å¯ç”¨é…ç½®â­ğŸ‚

Eureka Serverå³æœåŠ¡çš„æ³¨å†Œä¸­å¿ƒï¼Œåœ¨åˆšæ‰çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªEurekaServerï¼Œäº‹å®ä¸ŠEurekaServerä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªé›†ç¾¤ï¼Œå½¢æˆé«˜å¯ç”¨çš„Eurekaä¸­å¿ƒã€‚

å¤šä¸ªEureka Serverä¹‹é—´ä¹Ÿä¼šäº’ç›¸æ³¨å†Œä¸ºæœåŠ¡ï¼Œå½“æœåŠ¡æä¾›è€…æ³¨å†Œåˆ°Eureka Serveré›†ç¾¤ä¸­çš„æŸä¸ªèŠ‚ç‚¹æ—¶ï¼Œè¯¥èŠ‚ç‚¹ä¼šæŠŠæœåŠ¡çš„ä¿¡æ¯åŒæ­¥ç»™é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œä»è€Œå®ç°é«˜å¯ç”¨é›†ç¾¤ã€‚å› æ­¤ï¼Œæ— è®ºå®¢æˆ·ç«¯è®¿é—®åˆ°Eureka Serveré›†ç¾¤ä¸­çš„ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œéƒ½å¯ä»¥è·å–åˆ°å®Œæ•´çš„æœåŠ¡åˆ—è¡¨ä¿¡æ¯ã€‚è€Œä½œä¸ºå®¢æˆ·ç«¯ï¼Œéœ€è¦æŠŠä¿¡æ¯æ³¨å†Œåˆ°æ¯ä¸ªEurekaä¸­ã€‚

æˆ‘ä»¬ç°åœ¨æƒ³è¦è®©æ³¨å†Œä¸­å¿ƒå®ç°é«˜å¯ç”¨é…ç½®ï¼Œä¸ºæ­¤æ³¨å†Œä¸­å¿ƒéœ€è¦å®ç°é›†ç¾¤ï¼Œæˆ‘ä»¬è®©æ³¨å†Œä¸­å¿ƒ1çš„ç«¯å£ä¸º10086ï¼Œæ³¨å†Œä¸­å¿ƒ2çš„ç«¯å£ä¸º10087ã€‚

å®ç°æ³¨å†Œä¸­å¿ƒçš„é«˜å¯ç”¨éœ€è¦åˆ†æˆä¸¤éƒ¨åˆ†ï¼š

- **1.æ³¨å†Œä¸­å¿ƒè‡ªå·±å½¢æˆé›†ç¾¤ï¼Œæ¯ä¸ªæ³¨å†Œä¸­å¿ƒæˆå‘˜éœ€è¦ç›¸äº’æ³¨å†Œ**

![](SpringCloud.assets/Snipaste_2022-05-08_09-55-28.png)

![](SpringCloud.assets/Snipaste_2022-05-08_09-56-49.png)

![](SpringCloud.assets/Snipaste_2022-05-08_09-57-23.png)

æ­¤æ—¶å¯ä»¥çœ‹åˆ°æ³¨å†Œä¸­å¿ƒå·²ç»æœ‰ä¸¤å°æœºå•¦ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œç”±äºä¸¤å°æœº==å…±ç”¨ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹å®Œå¯åŠ¨ä¸€å°ï¼Œå†ä¿®æ”¹å†å¯åŠ¨å³å¯ï¼==æˆ–è€…æˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‰ç…§å¦‚ä¸‹çš„æ–¹å¼ä¿®æ”¹ï¼š

![](SpringCloud.assets/Snipaste_2022-05-08_10-09-01.png)

==ä¹Ÿå°±æ˜¯10086æ³¨å†Œåˆ°10087ä¸Šï¼Œè€Œ10087æ³¨å†Œåˆ°10086ä¸Šã€‚è¿™æ ·å°±å½¢æˆé«˜å¯ç”¨é…ç½®å•¦ï¼ã€‚==

**10086çš„æ³¨å†Œä¸­å¿ƒ1çš„é…ç½®æ–‡ä»¶**ï¼š10086æ³¨å†Œåˆ°10087ä¸Š

~~~yaml
server:
  port: 10086
  
#é…ç½®æœåŠ¡ID
spring:
  application:
    name: eureka-server   # ä¸è¦å¤§å†™å’Œä¸‹åˆ’çº¿
    
#é…ç½®eurekaå®¢æˆ·ç«¯é…ç½®
eureka:
  client:
    # register-with-eureka: false  # ä¸è®©å½“å‰æœåŠ¡æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ
    # fetch-registry: false #ä¸æ‹‰å–æ³¨å†Œä¿¡æ¯
    service-url:
      defaultZone: http://localhost:10087/eureka/  #å‘Šè¯‰ç°åœ¨çœŸæ­£çš„æ³¨å†Œä¸­å¿ƒçš„åœ°å€
     
~~~

**10087æ³¨å†Œä¸­å¿ƒ2çš„é…ç½®æ–‡ä»¶**ï¼š10087æ³¨å†Œåˆ°10086ä¸Š

~~~yaml
server:
  port: 10087
  
#é…ç½®æœåŠ¡ID
spring:
  application:
    name: eureka-server   # ä¸è¦å¤§å†™å’Œä¸‹åˆ’çº¿
    
#é…ç½®eurekaå®¢æˆ·ç«¯é…ç½®
eureka:
  client:
    # register-with-eureka: false  # ä¸è®©å½“å‰æœåŠ¡æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ
    # fetch-registry: false #ä¸æ‹‰å–æ³¨å†Œä¿¡æ¯
    service-url:
      defaultZone: http://localhost:10086/eureka/  #å‘Šè¯‰ç°åœ¨çœŸæ­£çš„æ³¨å†Œä¸­å¿ƒçš„åœ°å€
     
~~~

æ­¤æ—¶æˆ‘ä»¬è®¿é—®http://localhost:10087/,å¯ä»¥çœ‹åˆ°é«˜å¯ç”¨çš„é…ç½®å·²ç»é…ç½®å®Œæ¯•ï¼

![](SpringCloud.assets/Snipaste_2022-05-08_10-09-46.png)

- **2.æœåŠ¡æä¾›æ–¹å’ŒæœåŠ¡æ¶ˆè´¹æ–¹éœ€è¦åŒæ—¶æ³¨å†Œåˆ°å¤šä¸ªæ³¨å†Œä¸­å¿ƒä¸Š**

**æœåŠ¡æ¶ˆè´¹æ–¹é…ç½®æ–‡ä»¶**

~~~yaml
# ç«¯å£
server:
  port: 8080

# æ•°æ®æº
spring:
  application:
    name: user-consumer #å®šä¹‰æœåŠ¡ID
 
#eureké…ç½®
eureka:
  client:
    service-url: #å¤šä¸ªæ³¨å†Œä¸­å¿ƒï¼Œç”¨é€—å·åˆ†å‰²
      defaultZone: http://localhost:10086/eureka/,http://localhost:10087/eureka/
~~~

**æœåŠ¡æä¾›æ–¹é…ç½®æ–‡ä»¶**

~~~yaml
# ç«¯å£
server:
  port: 8081

# æ•°æ®æº
spring:
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/test
    username: root
    password: 123456
  jpa:
    show-sql: true
  application:
    name: user-service #å®šä¹‰æœåŠ¡ID
 
#eureké…ç½®
eureka:
  client:
    service-url:
      defaultZone: http://localhost:10086/eureka/,http://localhost:10087/eureka/
      
~~~

### 4.6 æœåŠ¡æä¾›è€…çš„å…¶ä»–é…ç½®â­ğŸ‚

æœåŠ¡æä¾›è€…åœ¨å¯åŠ¨æ—¶ï¼Œä¼šæ£€æµ‹é…ç½®å±æ€§ä¸­çš„ï¼šeureka.client.register-with-erueka=trueå‚æ•°æ˜¯å¦æ­£ç¡®ï¼Œäº‹å®ä¸Šé»˜è®¤å°±æ˜¯trueã€‚å¦‚æœå€¼ç¡®å®ä¸ºtrueï¼Œåˆ™ä¼šå‘EurekaServerå‘èµ·ä¸€ä¸ªRestè¯·æ±‚ï¼Œå¹¶æºå¸¦è‡ªå·±çš„å…ƒæ•°æ®ä¿¡æ¯ï¼ŒEureka Serverä¼šæŠŠè¿™äº›ä¿¡æ¯ä¿å­˜åˆ°ä¸€ä¸ªåŒå±‚Mapç»“æ„ä¸­ã€‚ç¬¬ä¸€å±‚Mapçš„Keyå°±æ˜¯æœåŠ¡åç§°ï¼Œç¬¬äºŒå±‚Mapçš„keyæ˜¯æœåŠ¡çš„å®ä¾‹idã€‚

æˆ‘ä»¬è¿˜å¯ä»¥å®šä¹‰æœåŠ¡æä¾›è€…çš„ä¸€äº›é…ç½®ï¼š

- 1ã€å¯ä»¥è‡ªå®šä¹‰ä¸ŠæŠ¥ipåœ°å€
- 2ã€å¯ä»¥è‡ªå®šä¹‰æœ¬èº«çš„å®ä¾‹ID
- 3ã€é…ç½®ç»­çº¦æ—¶é—´

==1.å¯ä»¥è‡ªå®šä¹‰ä¸ŠæŠ¥ipåœ°å€==

![](SpringCloud.assets/Snipaste_2022-05-08_10-34-16.png)

æˆ‘ä»¬æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒçš„hostä¸»æœºåæˆ‘ä»¬æ˜¯å¯ä»¥ä¿®æ”¹æˆæˆ‘ä»¬æƒ³è¦çš„é…ç½®çš„ï¼Œä¸ºæ­¤æˆ‘ä»¬ä¿®æ”¹æœåŠ¡æä¾›æ–¹çš„é…ç½®æ–‡ä»¶ï¼š

~~~yaml
# ç«¯å£
server:
  port: 8081

# æ•°æ®æº
spring:
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/test
    username: root
    password: 123456
  jpa:
    show-sql: true
  application:
    name: user-service #å®šä¹‰æœåŠ¡ID
 
#eureké…ç½®
eureka:
  client:
    service-url:
      defaultZone: http://localhost:10086/eureka/,http://localhost:10087/eureka/
  instance:
    prefer-ip-address: true  #è¿™ä¸ªè®¾ç½®ä¸ºtrueä»£è¡¨ä¸ŠæŠ¥è‡ªå·±çš„ipï¼Œè€Œä¸æ˜¯ç”¨ä¸»æœºå  
    ip-address: 127.0.0.1    # ä»£è¡¨æ³¨å†Œçš„ipåœ°å€ä¸ºè‡ªå·±æŒ‡å®šçš„IPï¼Œè€Œä¸æ˜¯é»˜è®¤è·å–çš„ host  "192.168.0.104" 
    
~~~

![](SpringCloud.assets/Snipaste_2022-05-08_10-57-28.png)

==2ã€å¯ä»¥è‡ªå®šä¹‰æœ¬èº«çš„å®ä¾‹ID==

æˆ‘ä»¬é»˜è®¤æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒä¸Šå±•ç¤ºåˆ°statusæ çš„å°±æ˜¯å®ä¾‹IDï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä¿®æ”¹å±•ç¤ºåœ¨Eurekaä¸Šçš„IDåã€‚

~~~yaml
# ç«¯å£
server:
  port: 8081

# æ•°æ®æº
spring:
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/test
    username: root
    password: 123456
  jpa:
    show-sql: true
  application:
    name: user-service #å®šä¹‰æœåŠ¡ID
 
#eureké…ç½®
eureka:
  client:
    service-url:
      defaultZone: http://localhost:10086/eureka/,http://localhost:10087/eureka/
  instance:
    prefer-ip-address: true  #è¿™ä¸ªè®¾ç½®ä¸ºtrueä»£è¡¨ä¸ŠæŠ¥è‡ªå·±çš„ipï¼Œè€Œä¸æ˜¯ç”¨ä¸»æœºå  
    ip-address: 127.0.0.1    # ä»£è¡¨æ³¨å†Œçš„ipåœ°å€ä¸ºè‡ªå·±æŒ‡å®šçš„IPï¼Œè€Œä¸æ˜¯é»˜è®¤è·å–çš„ host  "192.168.0.104"
    instance-id:  ${eureka.instance.ip-address}:${server.port} #è‡ªå®šä¹‰å®ä¾‹ID
    
~~~

![](SpringCloud.assets/Snipaste_2022-05-08_11-05-27.png)

==3ã€é…ç½®ç»­çº¦æ—¶é—´==

eurekaå®¢æˆ·ç«¯é»˜è®¤ç»­çº¦æ—¶é—´æ˜¯30ç§’æ¯æ¬¡ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹è¿™ä¸ªç»­çº¦æ—¶é—´ï¼

~~~yaml
# ç«¯å£
server:
  port: 8081

# æ•°æ®æº
spring:
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/test
    username: root
    password: 123456
  jpa:
    show-sql: true
  application:
    name: user-service #å®šä¹‰æœåŠ¡ID
 
#eureké…ç½®
eureka:
  client:
    service-url:
      defaultZone: http://localhost:10086/eureka/,http://localhost:10087/eureka/
  instance:
    lease-renewal-interval-in-seconds: 30 #é»˜è®¤å€¼æ˜¯30ç§’ï¼Œç”Ÿäº§ç¯å¢ƒä¸€èˆ¬ä¸ä¼šæ”¹
    prefer-ip-address: true  #è¿™ä¸ªè®¾ç½®ä¸ºtrueä»£è¡¨ä¸ŠæŠ¥è‡ªå·±çš„ipï¼Œè€Œä¸æ˜¯ç”¨ä¸»æœºå  
    ip-address: 127.0.0.1    # ä»£è¡¨æ³¨å†Œçš„ipåœ°å€ä¸ºè‡ªå·±æŒ‡å®šçš„IPï¼Œè€Œä¸æ˜¯é»˜è®¤è·å–çš„ host  "192.168.0.104"
    instance-id:  ${eureka.instance.ip-address}:${server.port} #è‡ªå®šä¹‰å®ä¾‹ID 
~~~

### 4.7 æœåŠ¡æ¶ˆè´¹è€…çš„å…¶ä»–é…ç½®

å½“æœåŠ¡æ¶ˆè´¹è€…å¯åŠ¨æ—¶ï¼Œä¼šæ£€æµ‹eureka.client.fetch-registry=trueå‚æ•°çš„å€¼ï¼Œå¦‚æœä¸ºtrueï¼Œåˆ™ä¼šä»Eureka ServeræœåŠ¡çš„åˆ—è¡¨åªè¯»å¤‡ä»½ï¼Œç„¶åç¼“å­˜åœ¨æœ¬åœ°ã€‚å¹¶ä¸”æ¯éš”30ç§’ä¼šé‡æ–°è·å–å¹¶æ›´æ–°æ•°æ®ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¿®æ”¹è¿™ä¸ªå€¼ã€‚

~~~yaml
# ç«¯å£
server:
  port: 8080

# æ•°æ®æº
spring:
  application:
    name: user-consumer #å®šä¹‰æœåŠ¡ID
 
#eureké…ç½®
eureka:
  client:
    registry-fetch-interval-seconds: 30  #æœåŠ¡æ‹‰å–æ—¶é—´ï¼Œé»˜è®¤å€¼ä¹Ÿæ˜¯30ç§’ ç”Ÿäº§ç¯å¢ƒä¸€èˆ¬ä¸ä¼šæ”¹
    instance-info-replication-interval-seconds: 5 # å®ä¾‹æ›¿æ¢æ—¶é—´
    service-url: #å¤šä¸ªæ³¨å†Œä¸­å¿ƒï¼Œç”¨é€—å·åˆ†å‰²
      defaultZone: http://localhost:10086/eureka/,http://localhost:10087/eureka/
      
~~~

### 4.8 æœåŠ¡ä¸‹çº¿ã€å¤±æ•ˆå‰”é™¤

å½“æœåŠ¡è¿›è¡Œæ­£å¸¸å…³é—­æ“ä½œæ—¶ï¼Œå®ƒä¼šè§¦å‘ä¸€ä¸ªæœåŠ¡ä¸‹çº¿çš„RESTè¯·æ±‚ç»™Eureka Serverï¼Œå‘Šè¯‰æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼šâ€œæˆ‘è¦ä¸‹çº¿äº†â€ã€‚æœåŠ¡ä¸­å¿ƒæ¥å—åˆ°è¯·æ±‚ä¹‹åï¼Œå°†è¯¥æœåŠ¡ç½®ä¸º==ä¸‹çº¿çŠ¶æ€==ã€‚

è€Œæœ‰æ—¶æˆ‘ä»¬çš„æœåŠ¡å¯èƒ½ç”±äºå†…å­˜æº¢å‡ºæˆ–ç½‘ç»œæ•…éšœç­‰åŸå› ä½¿å¾—æœåŠ¡ä¸èƒ½æ­£å¸¸çš„å·¥ä½œï¼Œè€ŒæœåŠ¡æ³¨å†Œä¸­å¿ƒå¹¶æœªæ”¶åˆ°â€œæœåŠ¡ä¸‹çº¿â€çš„è¯·æ±‚ã€‚ç›¸å¯¹äºæœåŠ¡æä¾›è€…çš„â€œæœåŠ¡ç»­çº¦â€æ“ä½œï¼ŒæœåŠ¡æ³¨å†Œä¸­å¿ƒåœ¨å¯åŠ¨æ—¶ä¼šåˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œé»˜è®¤æ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆé»˜è®¤ä¸º60ç§’ï¼‰å°†å½“å‰æ¸…å•ä¸­è¶…æ—¶ï¼ˆé»˜è®¤ä¸º90ç§’ï¼‰æ²¡æœ‰ç»­çº¦çš„æœåŠ¡å‰”é™¤ï¼Œè¿™ä¸ªæ“ä½œè¢«ç§°ä¸º==å¤±æ•ˆå‰”é™¤==ã€‚

æŸ¥çœ‹javaçš„åå°è¿›ç¨‹ï¼šjps
windowsæ¼”ç¤ºæ€æ­»è¿›ç¨‹ï¼š taskkill [/pid] [idå€¼] [/F]   

å¯ä»¥é€šè¿‡eureka.server.eviction-interval-timer-in-mså‚æ•°å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚

æˆ‘ä»¬å¼‚å¸¸æš´åŠ›å…³åœä¸€ä¸ªæœåŠ¡ï¼Œå°±ä¼šåœ¨Eurekaé¢æ¿çœ‹åˆ°ä¸€æ¡è­¦å‘Šï¼š

![1562428241904](SpringCloud.assets/1562428241904.png)

```
è¿™æ˜¯è§¦å‘äº†Eurekaçš„è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‚å½“æœåŠ¡æœªæŒ‰æ—¶è¿›è¡Œå¿ƒè·³ç»­çº¦æ—¶ï¼ŒEurekaä¼šç»Ÿè®¡æœåŠ¡å®ä¾‹æœ€è¿‘15åˆ†é’Ÿå¿ƒè·³ç»­çº¦çš„æ¯”ä¾‹æ˜¯å¦ä½äºäº†85%ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œå› ä¸ºç½‘ç»œå»¶è¿Ÿç­‰åŸå› ï¼Œå¿ƒè·³å¤±è´¥å®ä¾‹çš„æ¯”ä¾‹å¾ˆæœ‰å¯èƒ½è¶…æ ‡ï¼Œä½†æ˜¯æ­¤æ—¶å°±æŠŠæœåŠ¡å‰”é™¤åˆ—è¡¨å¹¶ä¸å¦¥å½“ï¼Œå› ä¸ºæœåŠ¡å¯èƒ½æ²¡æœ‰å®•æœºã€‚Eurekaåœ¨è¿™æ®µæ—¶é—´å†…ä¸ä¼šå‰”é™¤ä»»ä½•æœåŠ¡å®ä¾‹ï¼Œç›´åˆ°ç½‘ç»œæ¢å¤æ­£å¸¸ã€‚ç”Ÿäº§ç¯å¢ƒä¸‹è¿™å¾ˆæœ‰æ•ˆï¼Œä¿è¯äº†å¤§å¤šæ•°æœåŠ¡ä¾ç„¶å¯ç”¨ï¼Œä¸è¿‡ä¹Ÿæœ‰å¯èƒ½è·å–åˆ°å¤±è´¥çš„æœåŠ¡å®ä¾‹ï¼Œå› æ­¤æœåŠ¡è°ƒç”¨è€…å¿…é¡»åšå¥½æœåŠ¡çš„å¤±è´¥å®¹é”™ã€‚
```

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„é…ç½®æ¥å…³åœè‡ªæˆ‘ä¿æŠ¤ï¼š

```yaml
eureka:
  server:
    enable-self-preservation: false # å…³é—­è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ï¼ˆç¼ºçœä¸ºæ‰“å¼€ï¼‰
```

## 5.Ribbonç»„ä»¶â­ğŸ

Ribbonæ˜¯ä¸€ä¸ªè´Ÿè½½å‡è¡¡ç»„ä»¶ï¼Œé»˜è®¤æ˜¯é›†æˆåœ¨Eurekaä¸­ï¼Œé»˜è®¤ä½¿ç”¨çš„ç­–ç•¥æ˜¯è´Ÿè½½å‡è¡¡ï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒéœ€è¦

urekaä¸­å·²ç»é›†æˆäº†Ribbonï¼Œæ‰€ä»¥æˆ‘ä»¬æ— éœ€å¼•å…¥æ–°çš„ä¾èµ–ã€‚ç›´æ¥ä¿®æ”¹ä»£ç ï¼š

åœ¨RestTemplateæ·»åŠ @LoadBalancedæ³¨è§£ï¼š

~~~java
package com.atguigu;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.context.annotation.Bean;
import org.springframework.web.client.RestTemplate;

@SpringBootApplication
@EnableDiscoveryClient
public class ConsumerApplication {
	public static void main(String[] args) {
		SpringApplication.run(ConsumerApplication.class, args);
	}
	
	// åˆ›å»ºä¸€ä¸ªRestæ¨¡æ¿
	@Bean
	@LoadBalanced   // å¼€å¯è´Ÿè½½å‡è¡¡
	public RestTemplate restTemplate() {
		return  new RestTemplate();
	}
}
~~~

~~~java
package com.atguigu.controller;

import java.util.List;
import java.util.Random;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.client.discovery.DiscoveryClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

@RestController
public class ConsumerController {
	@Autowired
	private RestTemplate restTemplate;
		
	@GetMapping("/consumer/{id}")
    public String consumer(@PathVariable Integer id) {
		// è´Ÿè½½å‡è¡¡ï¼šæŠŠipæ›¿æ¢æˆæœåŠ¡ID
    	String urlString = "http://USER-SERVICE/user/"+id;
    	// è¿œç¨‹è°ƒç”¨
    	String user = restTemplate.getForObject(urlString, String.class);
        return user;
	}
	
}

~~~

æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¿®æ”¹ä»–çš„é»˜è®¤çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œé»˜è®¤ç­–ç•¥æ˜¯**è½®è¯¢**ã€‚

### Ribbonè´Ÿè½½å‡è¡¡ç­–ç•¥

```markdown
# 1.ribbonè´Ÿè½½å‡è¡¡ç®—æ³•
- RoundRobinRule         		è½®è®­ç­–ç•¥	æŒ‰é¡ºåºå¾ªç¯é€‰æ‹© Server 
- RandomRule             		éšæœºç­–ç•¥	éšæœºé€‰æ‹© Server  
- AvailabilityFilteringRule å¯ç”¨è¿‡æ»¤ç­–ç•¥
 	`ä¼šå…ˆè¿‡æ»¤ç”±äºå¤šæ¬¡è®¿é—®æ•…éšœè€Œå¤„äºæ–­è·¯å™¨è·³é—¸çŠ¶æ€çš„æœåŠ¡ï¼Œè¿˜æœ‰å¹¶å‘çš„è¿æ¥æ•°é‡è¶…è¿‡é˜ˆå€¼çš„æœåŠ¡ï¼Œç„¶åå¯¹å‰©ä½™çš„æœåŠ¡åˆ—è¡¨æŒ‰ç…§è½®è¯¢ç­–ç•¥è¿›è¡Œ		è®¿é—®

- WeightedResponseTimeRule  å“åº”æ—¶é—´åŠ æƒç­–ç•¥   
	`æ ¹æ®å¹³å‡å“åº”çš„æ—¶é—´è®¡ç®—æ‰€æœ‰æœåŠ¡çš„æƒé‡ï¼Œå“åº”æ—¶é—´è¶Šå¿«æœåŠ¡æƒé‡è¶Šå¤§è¢«é€‰ä¸­çš„æ¦‚ç‡è¶Šé«˜ï¼Œåˆšå¯åŠ¨æ—¶å¦‚æœç»Ÿè®¡ä¿¡æ¯ä¸è¶³ï¼Œåˆ™ä½¿ç”¨		
		RoundRobinRuleç­–ç•¥ï¼Œç­‰ç»Ÿè®¡ä¿¡æ¯è¶³å¤Ÿä¼šåˆ‡æ¢åˆ°

- RetryRule                 é‡è¯•ç­–ç•¥          
	`å…ˆæŒ‰ç…§RoundRobinRuleçš„ç­–ç•¥è·å–æœåŠ¡ï¼Œå¦‚æœè·å–å¤±è´¥åˆ™åœ¨åˆ¶å®šæ—¶é—´å†…è¿›è¡Œé‡è¯•ï¼Œè·å–å¯ç”¨çš„æœåŠ¡ã€‚
	
- BestAviableRule           æœ€ä½å¹¶å‘ç­–ç•¥     
	`ä¼šå…ˆè¿‡æ»¤æ‰ç”±äºå¤šæ¬¡è®¿é—®æ•…éšœè€Œå¤„äºæ–­è·¯å™¨è·³é—¸çŠ¶æ€çš„æœåŠ¡ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ªå¹¶å‘é‡æœ€å°çš„æœåŠ¡
```

![image-20200713162940968](SpringCloud.assets/image-20200713162940968.png)

### ä¿®æ”¹æœåŠ¡çš„é»˜è®¤è´Ÿè½½å‡è¡¡ç­–ç•¥

SpringBootä¹Ÿå¸®æˆ‘ä»¬æä¾›äº†ä¿®æ”¹è´Ÿè½½å‡è¡¡è§„åˆ™çš„é…ç½®å…¥å£ï¼š

~~~yaml
user-service:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule
~~~

æ ¼å¼æ˜¯ï¼š==**{æœåŠ¡åç§°}.ribbon.NFLoadBalancerRuleClassNameï¼Œå€¼å°±æ˜¯IRuleçš„å®ç°ç±»ã€‚**==

## 6.OpenFeignâ­ğŸ

åœ¨å‰é¢çš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Ribbonçš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œå¤§å¤§ç®€åŒ–äº†è¿œç¨‹è°ƒç”¨æ—¶çš„ä»£ç ï¼š

```java
String baseUrl = "http://user-service/user/";
User user = this.restTemplate.getForObject(baseUrl + id, User.class)
```

å¦‚æœå°±å­¦åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä»¥åéœ€è¦ç¼–å†™ç±»ä¼¼çš„å¤§é‡é‡å¤ä»£ç ï¼Œæ ¼å¼åŸºæœ¬ç›¸åŒï¼Œæ— éå‚æ•°ä¸ä¸€æ ·ã€‚æœ‰æ²¡æœ‰æ›´ä¼˜é›…çš„æ–¹å¼ï¼Œæ¥å¯¹è¿™äº›ä»£ç å†æ¬¡ä¼˜åŒ–å‘¢ï¼Ÿè¿™å°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦å­¦çš„OpenFeignçš„åŠŸèƒ½äº†ã€‚

OpenFeignç›®å‰æ˜¯SpringCloudçš„äºŒçº§å­é¡¹ç›®ã€‚å¹³æ—¶è¯´çš„Feignæ˜¯NetFlixä¸‹çš„Feignï¼Œè€Œæˆ‘ä»¬ç°åœ¨å­¦ä¹ çš„OeenFeignæ˜¯Springæä¾›çš„ã€‚

OpenFeignæ˜¯ä¸€ç§å£°æ˜å¼çš„ï¼Œæ¨¡æ¿åŒ–çš„Httpå®¢æˆ·ç«¯ï¼ˆä»…åœ¨Application Clientä¸­ä½¿ç”¨ï¼‰ï¼Œå…¶ä½œç”¨æ˜¯ï¼š**å£°æ˜å¼æœåŠ¡è°ƒç”¨**ã€‚å£°æ˜å¼è°ƒç”¨æŒ‡çš„æ˜¯ï¼Œå°±åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·è°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼Œè€Œæ— éœ€æ„ŸçŸ¥æ“ä½œè¿œç¨‹Httpè¯·æ±‚ã€‚==å®ƒæ˜¯ä¸€ç§æ›¿ä»£RestTemplateçš„æŠ€æœ¯ã€‚==

ç®€å•æ¥è¯´ï¼šOpenFeignå°±æ˜¯Springæä¾›çš„å£°æ˜å¼è¿œç¨‹æœåŠ¡è°ƒç”¨æŠ€æœ¯ã€‚

### 6.1 å…¥é—¨ä½¿ç”¨â­

æˆ‘ä»¬ä½¿ç”¨å°šç¡…è°·çš„ä»£ç è¿›è¡Œå†æ¬¡å­¦ä¹ ã€‚OpenFeignçš„é…ç½®åœ¨æœåŠ¡æ¶ˆè´¹æ–¹ä¸€ç«¯ã€‚ä½¿ç”¨OpenFeignçš„æ­¥éª¤å¦‚ä¸‹ï¼š

- 1.å¯¼å…¥èµ·æ­¥ä¾èµ–
- 2.ç¼–å†™é…ç½®æ–‡ä»¶
- 3.å¯åŠ¨ç±»æ·»åŠ OpenFeignæ³¨è§£
- **4.ç¼–å†™OpenFeignæ¥å£**
- 5.Controlleræ³¨å…¥OpenFeignæ¥å£ï¼Œå¹¶ä¸”è¿›è¡Œæ–¹æ³•è°ƒç”¨

==1.å¯¼å…¥èµ·æ­¥ä¾èµ–==

~~~xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>cloud2022</artifactId>
        <groupId>com.atguigu.springcloud</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>cloud-consumer-feign-order80</artifactId>

    <dependencies>
        <!--OpenFeign:åŸºäºæ¥å£çš„ç¼–ç¨‹æ–¹å¼ï¼Œç”¨äºè¿œç¨‹è°ƒç”¨çš„ï¼åƒè°ƒç”¨æœ¬åœ°ä»£ç ä¸€æ ·è°ƒç”¨è¿œç¨‹æ¥å£ -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
        <!--ä¾èµ–Eurekaå®¢æˆ·ç«¯ï¼Œå³å½“å‰çš„å¾®æœåŠ¡å¯¹äºEureka Serveræ¥è®²ï¼Œæˆ‘ä»¬æ˜¯å®¢æˆ·ç«¯ -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <!--å¥åº·ç›‘æ§ -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <!--çƒ­éƒ¨ç½² -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <artifactId>cloud-api-commons</artifactId>
            <groupId>com.atguigu.springcloud</groupId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
    </dependencies>

</project>
~~~

==2.ç¼–å†™é…ç½®æ–‡ä»¶==

~~~yaml
server:
  port: 80
spring:
  application:
    name: cloud-consuner-feign-order80
eureka:
  client:
    fetch-registry: true
    service-url:
      defaultZone: http://localhost:7001/eureka
    register-with-eureka: true
~~~

==3.å¯åŠ¨ç±»æ·»åŠ OpenFeignæ³¨è§£==

æˆ‘ä»¬éœ€è¦åœ¨è‘—å¯åŠ¨ç±»æ·»åŠ @EnableFeignClients 

è¿™ä¸ªæ³¨è§£ä»£è¡¨ï¼š**å¯ç”¨OpenFeignè¿œç¨‹è°ƒç”¨åŠŸèƒ½,åœ¨å¯åŠ¨Springå®¹å™¨çš„æ—¶å€™ï¼Œæ‰«æå½“å‰ç±»æ‰€åœ¨åŒ…åŠå…¶å­å­™åŒ…ä¸­çš„å…³äºOpenFeignçš„ç›¸å…³æ³¨è§£ï¼ˆFeignClientï¼‰ï¼Œå¹¶ä¸ºæ³¨è§£æ‰«æçš„æ¥å£åˆ›å»ºåŠ¨æ€ä»£ç†**

~~~java
package com.atguigu.springcloud;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.cloud.openfeign.EnableFeignClients;
import org.springframework.cloud.openfeign.FeignClient;

@SpringBootApplication
@EnableEurekaClient
@EnableFeignClients   // å¯ç”¨OpenFeignè¿œç¨‹è°ƒç”¨åŠŸèƒ½,åœ¨å¯åŠ¨Springå®¹å™¨çš„æ—¶å€™ï¼Œæ‰«æå½“å‰ç±»æ‰€åœ¨åŒ…åŠå…¶å­å­™åŒ…ä¸­çš„å…³äºOpenFeignçš„ç›¸å…³æ³¨è§£ï¼ˆFeignClientï¼‰ï¼Œå¹¶ä¸ºæ³¨è§£æ‰«æçš„æ¥å£åˆ›å»ºåŠ¨æ€ä»£ç†
public class OrderFeignMain80 {
    public static void main(String[] args) {
        SpringApplication.run(OrderFeignMain80.class,args);
    }
}
~~~

==**4.ç¼–å†™OpenFeignæ¥å£**==

è¿™ä¸€æ­¥æ˜¯æœ€é‡è¦çš„ï¼Œæˆ‘ä»¬åªéœ€è¦ç¼–å†™æ¥å£å°±å¯ä»¥å•¦ï¼Œä¸éœ€è¦å†™å®ç°ç±»,æ¥å£éœ€è¦åŠ ä¸Š**@FeignClientæ³¨è§£****

![](SpringCloud.assets/Snipaste_2022-05-08_16-56-09.png)

~~~java
package com.atguigu.springcloud.service;
/**
 * @FeignClientæ³¨è§£ï¼š
 *      openFeignæŠ€æœ¯æä¾›çš„æ³¨è§£ï¼Œï¼ŒåŠŸèƒ½æ˜¯è®©Springå®¹å™¨åˆ›å»ºä¸€ä¸ªåŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œ
 *      åŠ¨æ€ä»£ç†çš„å®ç°é€»è¾‘ï¼Œç”±spring-cloud-starter-openfeignæä¾›
 * æ€è€ƒï¼šè®¿é—®è¿œç¨‹æœåŠ¡éœ€è¦ä»€ä¹ˆ?
 *      1.è®¿é—®çš„æœåŠ¡çš„åº”ç”¨åï¼šspring.application.nameã€‚è¿œç¨‹è°ƒç”¨çš„æ—¶å€™ï¼Œä½¿ç”¨Ribbonåšè´Ÿè½½å‡è¡¡ã€‚
 *      ribbonæ˜¯åŸºäºæœåŠ¡çš„åº”ç”¨åç§°ï¼Œæ‰¾æœåŠ¡æ³¨å†Œä¿¡æ¯çš„ã€‚
 *      2.è®¿é—®è¿œç¨‹æœåŠ¡çš„è·¯å¾„ï¼Œå°±æ˜¯è¿œç¨‹æœåŠ¡æ§åˆ¶å™¨ä¸­çš„@RequestMappingæ³¨è§£ä¸­çš„valueå±æ€§å€¼ã€‚
 *      openfeignæ˜¯é€šè¿‡SpringMvcçš„æ³¨è§£@RequestMappingç­‰çš„valueå±æ€§å€¼æ¥å®šä¹‰è®¿é—®çš„è¿œç¨‹æœåŠ¡çš„è·¯å¾„çš„ã€‚
 */

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;

// è¿™ä¸ªç±»ä¸Šå¯ä»¥ä¸åŠ å…¶ä»–çš„æ³¨è§£ï¼ŒåŠ äº†@Componentæ³¨è§£ä¹Ÿæ²¡å…³ç³»ã€‚
@FeignClient("CLOUD-PAYMENT-SERVICE")
public interface TestFignClient {
    /**
     * å®šä¹‰æ–¹æ³•ï¼Œæ–¹æ³•å°±æ˜¯è¦è®¿é—®çš„è¿œç¨‹æœåŠ¡çš„æ–¹æ³•
     * è¦æ±‚ï¼š
     *    1.æ–¹æ³•åç§°ä»»æ„
     *    2.å‚æ•°è¡¨ä¸è¢«è°ƒç”¨çš„è¿œç¨‹æœåŠ¡çš„æ§åˆ¶å™¨æ–¹æ³•çš„å‚æ•°è¡¨ä¸€è‡´æˆ–è€…åŒ¹é…
     *    3.è¿”å›å€¼ ä¸è¢«è°ƒç”¨çš„è¿œç¨‹æœåŠ¡çš„æ§åˆ¶æ–¹æ³•çš„è¿”å›å€¼ä¸€è‡´ã€‚
     */
    @GetMapping("/payment/lb")
    public String getPaymentLB();
}
~~~

==5.Controlleræ³¨å…¥OpenFeignæ¥å£ï¼Œå¹¶ä¸”è¿›è¡Œæ–¹æ³•è°ƒç”¨==

~~~java
package com.atguigu.springcloud.controller;


import com.atguigu.springcloud.service.TestFignClient;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class TestFeignController {
    @Autowired
    private TestFignClient testFignClient;

    @GetMapping("/test")
    public String getProviderPort(){
        System.out.println(6666);
        return  testFignClient.getPaymentLB();
    }
}
~~~

### 6.2 OpenFeignè¯·æ±‚å‚æ•°â­ğŸ

è™½ç„¶å¾®æœåŠ¡æ˜¯éœ€è¦åŸºäºRestFulé£æ ¼æ¥ä¼ é€’å‚æ•°çš„ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥å°±æ˜¯æŒ‰ç…§SpringMVCæœ¬æ¥çš„å‚æ•°ä¼ é€’çš„æ–¹å¼å»è¯·æ±‚æœåŠ¡ï¼Œä¹Ÿæ˜¯å…è®¸çš„ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå½“OpenFeignæ¥å£è¿œç¨‹è°ƒç”¨æœåŠ¡çš„æ—¶å€™ï¼Œå¯¹äºè¿œç¨‹æœåŠ¡æ§åˆ¶å™¨æ–¹æ³•çš„å½¢å‚ä¸åŒï¼Œæœ¬åœ°æ¥å£åœ¨å†™æŠ½è±¡æ–¹æ³•çš„æ—¶å€™ï¼Œå¯¹äºå½¢å‚å’Œä¹¦å†™æ ¼å¼ä¹Ÿæ˜¯è¦æ±‚çš„ã€‚

è®¿é—®è¿œç¨‹æœåŠ¡çš„æ—¶å€™ï¼Œè¯·æ±‚å‚æ•°æ˜¯ä»€ä¹ˆï¼Ÿ

OpenFeignä¸èƒ½è”æƒ³è¿œç¨‹æœåŠ¡æœåŠ¡çš„è¯·æ±‚å‚æ•°åç§°ï¼Œæ¯•ç«Ÿè¯·æ±‚å‚æ•°æ˜¯éœ€è¦å’Œè¯·æ±‚è·¯å¾„åœ°å€ç›¸å…³çš„ï¼Œè€Œä¸æ˜¯å’Œæ–¹æ³•ç­¾åç›¸å…³çš„ï¼Œè¿™ä¸ªæ—¶å€™æ˜¯æ— æ³•å°†æœ¬åœ°å‚æ•°å‡†ç¡®èµ‹å€¼ç»™è¿œç¨‹æœåŠ¡çš„æ§åˆ¶å™¨çš„ã€‚æ•…æœ‰å¼ºåˆ¶è¦æ±‚ï¼š

#### 6.2.1 è¯·æ±‚å‚æ•°æ˜¯ç®€å•å‚æ•°ç±»å‹

>**å¦‚æœè¯·æ±‚å‚æ•°æ˜¯ç®€å•ç±»å‹çš„è¯·æ±‚å‚æ•°ï¼Œåˆ™å¿…é¡»ä½¿ç”¨@RequestParamæ³¨è§£æ¥æè¿°è¿™ä¸ªå‚æ•°ï¼Œä¸”æ³¨è§£çš„Valueå±æ€§å€¼ï¼Œå°±æ˜¯è¯·æ±‚å‚æ•°çš„åç§°ã€‚**

**è¿œç¨‹å¾®æœåŠ¡**

~~~java
 @GetMapping("/payment")
    public String getParam(String name ,int age){
        return "è¯·æ±‚å‚æ•°ä¸ºï¼šname="+name+",age="+age;
    }
~~~

**OpenFeignæœåŠ¡è°ƒç”¨æ–¹**

**service**

~~~java
/*OpenFeignä¸èƒ½è”æƒ³è¿œç¨‹æœåŠ¡æœåŠ¡çš„è¯·æ±‚å‚æ•°åç§°ï¼Œæ¯•ç«Ÿè¯·æ±‚å‚æ•°æ˜¯éœ€è¦å’Œè¯·æ±‚è·¯å¾„åœ°å€ç›¸å…³çš„ï¼Œè€Œä¸æ˜¯å’Œæ–¹æ³•ç­¾åç›¸å…³çš„ï¼Œè¿™ä¸ªæ—¶å€™æ˜¯æ— æ³•å°†æœ¬åœ°å‚æ•°å‡†ç¡®èµ‹å€¼ç»™è¿œç¨‹æœåŠ¡çš„æ§åˆ¶å™¨çš„ã€‚æ•…æœ‰å¼ºåˆ¶è¦æ±‚ï¼šå¦‚æœè¯·æ±‚å‚æ•°æ˜¯ç®€å•ç±»å‹çš„è¯·æ±‚å‚æ•°ï¼Œåˆ™å¿…é¡»ä½¿ç”¨@RequestParamæ³¨è§£æ¥æè¿°è¿™ä¸ªå‚æ•°ï¼Œä¸”æ³¨è§£çš„Valueå±æ€§å€¼ï¼Œå°±æ˜¯è¯·æ±‚å‚æ•°çš„åç§°ã€‚ 
*/
@GetMapping("/payment")
public String getParam(@RequestParam("name") String name ,@RequestParam("age") int age);
~~~

![](SpringCloud.assets/Snipaste_2022-05-08_17-28-47.png)

controller**

~~~java
 @GetMapping("/testParam")
    public String getProviderParam(String name,int age){
        System.out.println(6666);
        return  testFignClient.getParam(name,age);
    }
~~~

æˆ‘ä»¬è®¿é—®è·¯å¾„ï¼Œæ­¤æ—¶å¯ä»¥æ­£ç¡®è®¿é—®ï¼šhttp://localhost/testParam?name=admin&age=18

#### 6.2.2 RestFulé£æ ¼è¯·æ±‚å‚æ•°

å½“å‚æ•°ä¼ é€’æ˜¯é€šè¿‡Restfulé£æ ¼è¿›è¡Œå‚æ•°ä¼ é€’çš„æ—¶å€™ï¼Œæ­¤æ—¶

>**å¦‚æœè¯·æ±‚å‚æ•°æ˜¯ä¸€ä¸ªRestfulé£æ ¼çš„å‚æ•°ï¼Œåˆ™éœ€è¦ç»™OpenFeignæŠ½è±¡æ–¹æ³•æ–¹æ³•å‚æ•°æä¾›æ³¨è§£@PathVariable,å¹¶ä¸”æ³¨è§£çš„å±æ€§valueèµ‹å€¼ï¼Œvalueçš„å±æ€§å€¼ï¼Œå¯¹åº”è¿œç¨‹å¾®æœåŠ¡æ§åˆ¶å™¨ä¸­çš„RequestMappingä¸­çš„è·¯å¾„å˜é‡**

**æœåŠ¡æä¾›æ–¹**

~~~java
 @GetMapping("/payment/{remark}")
    public String getParam(@PathVariable("remark") String remark){
        return "è¯·æ±‚å‚æ•°ä¸ºï¼šremark="+remark;
    }
~~~

**æœåŠ¡æ¶ˆè´¹æ–¹**

**service**

~~~java
/*å¦‚æœè¯·æ±‚å‚æ•°æ˜¯ä¸€ä¸ªRestfulé£æ ¼çš„å‚æ•°ï¼Œåˆ™éœ€è¦ç»™OpenFeignæŠ½è±¡æ–¹æ³•æ–¹æ³•å‚æ•°æä¾›æ³¨è§£@PathVariable,å¹¶ä¸”æ³¨è§£çš„å±æ€§valueèµ‹å€¼ï¼Œvalueçš„å±æ€§å€¼ï¼Œå¯¹åº”è¿œç¨‹å¾®æœåŠ¡æ§åˆ¶å™¨ä¸­çš„RequestMappingä¸­çš„è·¯å¾„å˜é‡
*/
@GetMapping("/payment/{remark}")
public String getParam(@PathVariable("remark") String a);
~~~

**controller**

~~~java
  @GetMapping("/testParam")
    public String getProviderParam(){
        System.out.println(6666);
        return  testFignClient.getParam("hahahha");
    }

~~~

æˆ‘ä»¬è®¿é—®è·¯å¾„ï¼Œæ­¤æ—¶å¯ä»¥æ­£ç¡®è®¿é—®ï¼šhttp://localhost/testParam

#### 6.2.3å‚æ•°é€šè¿‡è¯·æ±‚ä½“ä¼ é€’

>**å¦‚æœè¯·æ±‚å‚æ•°æ˜¯é€šè¿‡è¯·æ±‚ä½“ä¼ é€’çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªå‚æ•°æœ‰ç‰¹å®šçš„è¦æ±‚ï¼Œé¦–å…ˆä¸€ä¸ªæ–¹æ³•ä¸­åªèƒ½æœ‰å”¯ä¸€çš„ä¸€ä¸ªè¯·æ±‚ä½“å‚æ•°ï¼Œä¸”è¿™ä¸ªå‚æ•°å¯ä»¥ä¸åšä»»ä½•çš„æ³¨è§£æè¿°ï¼Œä½†æ˜¯é€šå¸¸å»ºè®®ä½¿ç”¨@RequestBodyæ³¨è§£ä½¿ç”¨ï¼Œå› ä¸ºOpenFeignå¼ºåˆ¶å®šä¹‰ä¸€ä¸ªæ–¹æ³•çš„å‚æ•°è¡¨ä¸­ï¼Œå¦‚æœæœ‰å‚æ•°æ²¡æœ‰ä»»ä½•æ³¨è§£ä¿®é¥°ï¼Œè¿™ä¸ªå‚æ•°é€šè¿‡è¯·æ±‚ä½“ä¼ é€’ï¼Œä¸”è¯·æ±‚ä½“ä¸­åªèƒ½æœ‰å”¯ä¸€çš„ä¸€ä¸ªå‚æ•°ï¼Œæ–¹æ³•å‚æ•°è¡¨åªæœ‰å”¯ä¸€çš„ä¸€ä¸ªå‚æ•°å¯ä»¥ä¸åšä»»ä½•æ³¨è§£ä¿®é¥°**

**æœåŠ¡æä¾›æ–¹**

æ³¨æ„ï¼š==æ­¤æ—¶æ³¨è§£ä¸èƒ½å†™@RequestMapping==

~~~java
 @RequestMapping("/post")
    public String getParam(String name, int age, @RequestBody Map<String,Object> info){
        System.out.println("name="+name+";age ="+age+",info="+info);
        return  "Postæ–¹æ³•æ‰§è¡Œ";
    }
~~~

**OpenFeignæœåŠ¡æ¶ˆè´¹æ–¹**

**service**

~~~java
    @RequestMapping("/post")
    public String getParam(@RequestParam("name") String name, @RequestParam("age")int age, @RequestBody Map<String,Object> info);

~~~

**controller**

~~~java
   @GetMapping("/testParam")
    public String getProviderParam(String name ,int age){
        System.out.println(6666);
        Map<String,Object> info  = new HashMap<>();
        info.put("test","æµ‹è¯•è¯·æ±‚ä½“ä¼ é€’å‚æ•°");
        return  testFignClient.getParam(name,age,info);
    }
~~~

æˆ‘ä»¬è®¿é—®è·¯å¾„ï¼Œæ­¤æ—¶å¯ä»¥æ­£ç¡®è®¿é—®ï¼šhttp://localhost/testParam?name=admin&age=18

æ€»ç»“ï¼š==å®é™…ä¸ŠOpenFeignåº•å±‚æ˜¯ä½¿ç”¨HttpClientæ¥å®ç°çš„ï¼Œä¹‹æ‰€æœ‰æ²¡æœ‰ä½¿ç”¨RestTemplateï¼Œæ˜¯å› ä¸ºHttpClinetæ”¯æŒè¿æ¥æ± æŠ€æœ¯ã€‚==

### 6.3 OpenFeignæ•°æ®å‹ç¼©

ç”¨æˆ·åœ¨ç½‘ç»œè¯·æ±‚è¿‡ç¨‹ä¸­ï¼Œå¦‚æœç½‘ç»œä¸ä½³ã€ä¼ è¾“æ•°æ®è¿‡å¤§ï¼Œä¼šé€ æˆä½“éªŒå·®çš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å°†ä¼ è¾“æ•°æ®å‹ç¼©æå‡ä½“éªŒã€‚SpringCloud OpenFeignæ”¯æŒå¯¹è¯·æ±‚å’Œå“åº”è¿›è¡ŒGZIPå‹ç¼©ï¼Œä»¥å‡å°‘é€šä¿¡è¿‡ç¨‹ä¸­çš„æ€§èƒ½æŸè€—ã€‚

é€šè¿‡é…ç½®å¼€å¯è¯·æ±‚ä¸å“åº”çš„å‹ç¼©åŠŸèƒ½ï¼š(æ˜¯åœ¨æ¶ˆè´¹æ–¹çš„é…ç½®æ–‡ä»¶ä¸­å¼€å¯)

~~~yaml
feign:
	compression:
      request:
        enabled: true # å¼€å¯è¯·æ±‚å‹ç¼©ï¼Œä½¿ç”¨OpenFeignè®¿é—®è¿œç¨‹çš„æ—¶å€™ï¼Œè¯·æ±‚å‹ç¼©
      response:
        enabled: true # å¼€å¯å“åº”å‹ç¼©
~~~

ä¹Ÿå¯ä»¥å¯¹è¯·æ±‚çš„æ•°æ®ç±»å‹ï¼Œä»¥åŠè§¦å‘å‹ç¼©çš„å¤§å°ä¸‹é™è¿›è¡Œè®¾ç½®:

~~~yaml
feign:
	compression:
      request:
        enabled: true # å¼€å¯è¯·æ±‚å‹ç¼©
        mime-types:	text/html,application/xml,application/json # è®¾ç½®å‹ç¼©çš„æ•°æ®ç±»å‹ï¼Œè¯·æ±‚çš„context-typeæ˜¯ä»€ä¹ˆï¼Œæ‰å‹ç¼©è¯·æ±‚
        min-request-size: 2048 # è®¾ç½®è§¦å‘å‹ç¼©çš„å¤§å°ä¸‹é™ï¼Œè¯·æ±‚è¾¾åˆ°å¤šå°‘ä¸ªå­—èŠ‚ï¼Œæ‰å¼€å¯å‹ç¼©ï¼Œé»˜è®¤2048 2M
        #ä»¥ä¸Šæ•°æ®ç±»å‹ï¼Œå‹ç¼©å¤§å°ä¸‹é™å‡ä¸ºé»˜è®¤å€¼
      response:
        enabled: true # å¼€å¯å“åº”å‹ç¼©
~~~

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åˆšæ‰é…ç½®çš„æ˜¯å¾®æœåŠ¡å’Œå¾®æœåŠ¡ä¹‹é—´çš„é€šä¿¡çš„æ—¶å€™è¿›è¡Œçš„å‹ç¼©ä¼˜åŒ–ï¼Œåœ¨æœåŠ¡å™¨è¿”å›å“åº”ç»™åˆ°å®¢æˆ·ç«¯æµè§ˆå™¨çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥è®¾ç½®Tomcatä¼˜åŒ–ã€‚è®¾ç½®å¦‚ä¸‹ï¼š

~~~yaml
server:
  port: 80
  compression:
    enabled: true  # æ˜¯å¦å¼€å¯tomcatå“åº”å‹ç¼©ï¼Œé»˜è®¤æ˜¯false
    mime-types: text/html,application/xml,application/json # å“åº”å¤´content-typeæ˜¯ä»€ä¹ˆçš„æ—¶å€™ï¼Œå‹ç¼©
    min-response-size: 128 #å“åº”å®¹é‡å¤šå°‘å­—èŠ‚æ‰å‹ç¼©ï¼Œé»˜è®¤2048å­—èŠ‚

spring:
  application:
    name: cloud-consuner-feign-order80

eureka:
  client:
    fetch-registry: true
    service-url:
      defaultZone: http://localhost:7001/eureka
    register-with-eureka: true

feign:
  compression:
    request:
      enabled: true # å¼€å¯è¯·æ±‚å‹ç¼©
      mime-types:	text/html,application/xml,application/json # è®¾ç½®å‹ç¼©çš„æ•°æ®ç±»å‹ï¼Œè¯·æ±‚çš„context-typeæ˜¯ä»€ä¹ˆï¼Œæ‰å‹ç¼©è¯·æ±‚
      min-request-size: 2048 # è®¾ç½®è§¦å‘å‹ç¼©çš„å¤§å°ä¸‹é™ï¼Œè¯·æ±‚è¾¾åˆ°å¤šå°‘ä¸ªå­—èŠ‚ï¼Œæ‰å¼€å¯å‹ç¼©ï¼Œé»˜è®¤2048 2M
      #ä»¥ä¸Šæ•°æ®ç±»å‹ï¼Œå‹ç¼©å¤§å°ä¸‹é™å‡ä¸ºé»˜è®¤å€¼
    response:
      enabled: true # å¼€å¯å“åº”å‹ç¼©
~~~

![](SpringCloud.assets/Snipaste_2022-05-08_20-14-10.png)

![](SpringCloud.assets/Snipaste_2022-05-08_20-16-14.png)

### 6.4 é…ç½®å¯¹Ribbonçš„æ”¯æŒ

éœ€è¦è¯´æ˜çš„æ˜¯ï¼ŒFeignå·²ç»å†…ç½®äº†Ribbonï¼Œ

![](SpringCloud.assets/Snipaste_2022-05-14_11-32-15.png)

å› æ­¤æˆ‘ä»¬ä¸éœ€è¦é¢å¤–å¼•å…¥ä¾èµ–ï¼Œä¹Ÿä¸éœ€è¦å†æ³¨å†Œ`RestTemplate`å¯¹è±¡ã€‚

å¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥åƒä¸ŠèŠ‚è¯¾ä¸­è®²çš„é‚£æ ·å»é…ç½®Ribbonï¼Œå¯ä»¥é€šè¿‡ribbon.xxæ¥è¿›è¡Œå…¨å±€é…ç½®ã€‚ä¹Ÿå¯ä»¥é€šè¿‡æœåŠ¡å.ribbon.xxæ¥å¯¹æŒ‡å®šæœåŠ¡é…ç½®ï¼š

**å¯¹æŸä¸ªæœåŠ¡é…ç½®Ribbon**

~~~yaml
user-service:   
  ribbon:    
     NFLoadBalancerRuleClassName:  com.netflix.loadbalancer.RandomRule    # è´Ÿè½½å‡è¡¡ç­–ç•¥
     ConnectTimeout: 250 # Ribbonçš„è¿æ¥è¶…æ—¶æ—¶é—´    
     ReadTimeout: 1000 # Ribbonçš„æ•°æ®è¯»å–è¶…æ—¶æ—¶é—´    
     OkToRetryOnAllOperations: true # æ˜¯å¦å¯¹æ‰€æœ‰æ“ä½œéƒ½è¿›è¡Œé‡è¯•    
     MaxAutoRetriesNextServer: 1 # åˆ‡æ¢å®ä¾‹çš„é‡è¯•æ¬¡æ•°  
~~~

**å¯¹æ‰€æœ‰è¯·æ±‚é…ç½®Ribbonï¼š**

Feginå†…ç½®çš„ribboné»˜è®¤è®¾ç½®äº†è¯·æ±‚è¶…æ—¶æ—¶é•¿ï¼Œé»˜è®¤æ˜¯1000msï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰‹åŠ¨é…ç½®æ¥ä¿®æ”¹è¿™ä¸ªè¶…æ—¶æ—¶é•¿ï¼š

```yaml
ribbon:
  ReadTimeout: 2000 # è¯»å–è¶…æ—¶æ—¶é•¿
  ConnectTimeout: 1000 # å»ºç«‹é“¾æ¥çš„è¶…æ—¶æ—¶é•¿
```

ï¼Œå› ä¸ºribbonå†…éƒ¨æœ‰é‡è¯•æœºåˆ¶ï¼Œä¸€æ—¦è¶…æ—¶ï¼Œä¼šè‡ªåŠ¨é‡æ–°å‘èµ·è¯·æ±‚ã€‚å¦‚æœä¸å¸Œæœ›é‡è¯•ï¼Œå¯ä»¥æ·»åŠ é…ç½®ï¼š

```yaml
ribbon:
  ConnectTimeout: 500 # è¿æ¥è¶…æ—¶æ—¶é•¿
  ReadTimeout: 2000 # æ•°æ®é€šä¿¡è¶…æ—¶æ—¶é•¿
  MaxAutoRetries: 0 # å½“å‰æœåŠ¡å™¨çš„é‡è¯•æ¬¡æ•°
  MaxAutoRetriesNextServer: 1 # é‡è¯•å¤šå°‘ä¸ªæœåŠ¡èŠ‚ç‚¹
  OkToRetryOnAllOperations: false # æ˜¯å¦å¯¹æ‰€æœ‰çš„è¯·æ±‚æ–¹å¼éƒ½é‡è¯•ï¼Œé»˜è®¤æ˜¯trueï¼Œå¯¹æ‰€æœ‰è¯·æ±‚éƒ½é‡è¯•ï¼Œæ”¹ä¸ºfalse,åªå¯¹getè¯·æ±‚è¿›è¡Œé‡è¯•ã€‚
```

==å¦å¤–ï¼ŒHystrixçš„è¶…æ—¶æ—¶é—´ï¼Œåº”è¯¥æ¯”é‡è¯•çš„æ€»æ—¶é—´è¦å¤§ï¼Œæ¯”å¦‚å½“å‰æ¡ˆä¾‹ä¸­ï¼Œåº”è¯¥é… å¤§äº2500*2 = 5000==

![](SpringCloud.assets/Snipaste_2022-05-14_11-47-11.png)

### 6.5 é…ç½®å¯¹Hystrixçš„æ”¯æŒ

Feignå†…ç½®äº†å¯¹Hystrixæ”¯æŒï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥iä½¿ç”¨Hystrixç†”æ–­ã€‚

![](SpringCloud.assets/Snipaste_2022-05-14_12-06-49.png)

~~~java
package com.atguigu;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.SpringCloudApplication;
import org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.cloud.netflix.hystrix.EnableHystrix;
import org.springframework.cloud.openfeign.EnableFeignClients;
import org.springframework.context.annotation.Bean;
import org.springframework.web.client.RestTemplate;

@SpringBootApplication
@EnableDiscoveryClient
@EnableCircuitBreaker  // å¼€å¯ç†”æ–­å™¨  å®é™…ä¸Šä¹Ÿæœ‰@EnableHystrix ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯ç”¨@EnableCircuitBreakerï¼Œ
@EnableFeignClients // å¼€å¯Feignçš„è¿œç¨‹è°ƒç”¨
public class ConsumerApplication {
	public static void main(String[] args) {
		SpringApplication.run(ConsumerApplication.class, args);
	}
	
}
~~~

**å®ä½“ç±»**

~~~java
package com.atguigu.pojo;

import java.io.Serializable;


/**
   * ç”¨æˆ·å®ä½“ç±»
 * @author Admin
 *
 */
public class User implements Serializable{

	private Integer id;
	

	private String userName;
	

	private String password;
	

	private String name;

	public Integer getId() {
		return id;
	}

	public void setId(Integer id) {
		this.id = id;
	}

	

	public String getUserName() {
		return userName;
	}

	public void setUserName(String userName) {
		this.userName = userName;
	}

	public String getPassword() {
		return password;
	}

	public void setPassword(String password) {
		this.password = password;
	}

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}

	@Override
	public String toString() {
		return "User [id=" + id + ", username=" + userName + ", password=" + password + ", name=" + name + "]";
	}
}
~~~

**service**

~~~java
package com.atguigu.clients;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

import com.atguigu.pojo.User;

@FeignClient(value="USER-SERVICE")
public interface UserClent {
	// ä¼ªè£…æˆSpringMVCçš„controller
	@GetMapping("/user/{id}")
    public User findById(@PathVariable("id") Integer id) ;
}
~~~

ç¬¬ä¸€ç§ç†”æ–­æ–¹å¼ï¼š**ç›´æ¥åœ¨controlleræ–¹æ³•è¿›è¡Œç†”æ–­é…ç½®**ï¼Œæ­¤æ—¶å¯ä»¥ä¸ä¿®æ”¹é…ç½®æ–‡ä»¶

**controller**ã€‚

~~~java
package com.atguigu.controller;

import java.util.List;
import java.util.Random;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.client.discovery.DiscoveryClient;
import org.springframework.scheduling.support.SimpleTriggerContext;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import com.atguigu.clients.UserClent;
import com.atguigu.pojo.User;
import com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;
import com.netflix.hystrix.contrib.javanica.annotation.HystrixProperty;

@RestController
public class ConsumerController {
	@Autowired
	private UserClent userClent;
	
	@HystrixCommand(
			// ç†”æ–­é™çº§çš„æ–¹æ³•æ˜¯å“ªä¸ªï¼Œå½“å‰Controllerå¼‚å¸¸ï¼Œè¶…æ—¶æ‰ä¼šè°ƒç”¨ç†”æ–­é™çº§çš„æ–¹æ³•
			fallbackMethod = "fallbackMethodConsumer",
			commandProperties = {
					@HystrixProperty(name="execution.isolation.thread.timeoutInMilliseconds",value="1000")// é…ç½®å±æ€§ï¼Œè¶…æ—¶æ—¶é—´ï¼Œå®é™…ç”Ÿäº§ä¼šå°äº1000
			}		
			) // æ ‡è®°è¿™ä¸ªæ–¹æ³•éœ€è¦é™çº§
	@GetMapping("/consumer/{id}")
    public User consumer(@PathVariable Integer id) {
		User user = userClent.findById(id);
		return user;     
	}
	/**
	 * è¿™ä¸ªæ˜¯ç†”æ–­çš„æ–¹æ³•ï¼Œå®ƒçš„è¦æ±‚å¦‚ä¸‹ï¼š
	 * 1.ç†”æ–­çš„æ–¹æ³•éœ€è¦å’Œè¢«è°ƒç”¨çš„æ–¹æ³•çš„å‚æ•°ç±»å‹ä¸€è‡´ï¼
	 * 2.ç†”æ–­çš„æ–¹æ³•éœ€è¦å’Œè¢«è°ƒç”¨çš„æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ä¸€è‡´ï¼
	 * 
	 */
	public User fallbackMethodConsumer(Integer id) {
		return new User();
	}	
}
~~~

ç¬¬äºŒç§ç†”æ–­æ–¹å¼ï¼š**è§£å†³ä»£ç è€¦åˆçš„é—®é¢˜ï¼šé™çº§ç»„ä»¶ç±»**æ­¤æ—¶éœ€è¦æ˜¾ç¤ºå¼€å¯å¯¹Hystrixçš„æ”¯æŒã€‚

==å¼€å‘æ­¥éª¤ï¼š==

- å®šä¹‰UserClientæ¥å£
- å¤å†™UserClientæ¥å£çš„å®ç°ç±»
- åœ¨UserClientä¸­ï¼ŒæŒ‡å®šåˆšæ‰ç¼–å†™çš„å®ç°ç±»
- åœ¨é…ç½®æ–‡ä»¶ä¸­å¼€å¯Hystrixçš„æ”¯æŒ

**ç»„ä»¶ç±»**

~~~java
package com.atguigu.clients;

import org.springframework.stereotype.Component;

import com.atguigu.pojo.User;


@Component // é™çº§ç»„ä»¶ç±»éœ€è¦äº¤ç»™Springç®¡ç†
public class UserClientImpl implements UserClent {
 
	// é™çº§ç»„ä»¶ç±»éœ€è¦å®ç°Feignæ¥å£çš„æ–¹æ³•
	@Override
	public User findById(Integer id) {
		User user = new User();
		user.setId(id);
		user.setName("OpenFeignç†”æ–­ï¼");
		return user;
	}
}
~~~

**serviceæ¥å£**

~~~java
package com.atguigu.clients;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

import com.atguigu.pojo.User;

@FeignClient(value="USER-SERVICE",
   // fallbackså±æ€§æŒ‡å®šé™çº§ç±»
   fallback = UserClientImpl.class)
public interface UserClent {
	// ä¼ªè£…æˆSpringMVCçš„controller
	@GetMapping("/user/{id}")
    public User findById(@PathVariable("id") Integer id) ;
}
~~~

**controller**

~~~java
package com.atguigu.controller;

import java.util.List;
import java.util.Random;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.client.discovery.DiscoveryClient;
import org.springframework.scheduling.support.SimpleTriggerContext;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import com.atguigu.clients.UserClent;
import com.atguigu.pojo.User;
import com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;
import com.netflix.hystrix.contrib.javanica.annotation.HystrixProperty;

@RestController
public class ConsumerController {
	@Autowired
	private UserClent userClent;
	
	@GetMapping("/consumer/{id}")
    public User consumer(@PathVariable Integer id) {
		User user = userClent.findById(id);
		return user;
	}
	
}
~~~

**é…ç½®æ–‡ä»¶**

~~~yaml
# ç«¯å£
server:
  port: 8080

# æ•°æ®æº
spring:
  application:
    name: user-consumer #å®šä¹‰æœåŠ¡ID
 
#eureké…ç½®
eureka:
  client:
    registry-fetch-interval-seconds: 30  #æœåŠ¡æ‹‰å–æ—¶é—´ï¼Œé»˜è®¤å€¼ä¹Ÿæ˜¯30ç§’ ç”Ÿäº§ç¯å¢ƒä¸€èˆ¬ä¸ä¼šæ”¹
    instance-info-replication-interval-seconds: 5 # å®ä¾‹æ›¿æ¢æ—¶é—´
    service-url: #å¤šä¸ªæ³¨å†Œä¸­å¿ƒï¼Œç”¨é€—å·åˆ†å‰²
      defaultZone: http://localhost:10086/eureka/
      
# å…¨å±€ç†”æ–­æ—¶é—´
hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 2000  
            
#å¼€å¯OpenFeignä¸­ç†”æ–­å™¨çš„ä½¿ç”¨
feign:
  hystrix:
    enabled: true   #å¼€å¯Feignçš„ç†”æ–­åŠŸèƒ½
~~~

## 7.Hystrixç†”æ–­å™¨â­ğŸ

Hystrix,è‹±æ–‡æ„æ€æ˜¯è±ªçŒªï¼Œå…¨èº«æ˜¯åˆºï¼Œçœ‹èµ·æ¥å°±ä¸å¥½æƒ¹ï¼Œ==æ˜¯ä¸€ç§ä¿æŠ¤æœºåˆ¶ã€‚==

Hystrixä¹Ÿæ˜¯Netflixå…¬å¸çš„ä¸€æ¬¾ç»„ä»¶ã€‚

ä¸»é¡µï¼šhttps://github.com/Netflix/Hystrix/

![1562598311968](SpringCloud.assets/1562598311968.png) 

é‚£ä¹ˆHystrixçš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…·ä½“è¦ä¿æŠ¤ä»€ä¹ˆå‘¢ï¼Ÿ

Hystrixæ˜¯Netflixå¼€æºçš„ä¸€ä¸ªå»¶è¿Ÿå’Œå®¹é”™åº“ï¼Œç”¨äºéš”ç¦»è®¿é—®è¿œç¨‹æœåŠ¡ã€ç¬¬ä¸‰æ–¹åº“ï¼Œé˜²æ­¢å‡ºç°çº§è”å¤±è´¥ã€‚

==**é›ªå´©é—®é¢˜**==

å¾®æœåŠ¡ä¸­ï¼ŒæœåŠ¡é—´è°ƒç”¨å…³ç³»é”™ç»¼å¤æ‚ï¼Œä¸€ä¸ªè¯·æ±‚ï¼Œå¯èƒ½éœ€è¦è°ƒç”¨å¤šä¸ªå¾®æœåŠ¡æ¥å£æ‰èƒ½å®ç°ï¼Œä¼šå½¢æˆéå¸¸å¤æ‚çš„è°ƒç”¨é“¾è·¯ï¼š

![1562598446267](SpringCloud.assets/1562598446267.png) 

å¦‚å›¾ï¼Œä¸€æ¬¡ä¸šåŠ¡è¯·æ±‚ï¼Œéœ€è¦è°ƒç”¨Aã€Pã€Hã€Iå››ä¸ªæœåŠ¡ï¼Œè¿™å››ä¸ªæœåŠ¡åˆå¯èƒ½è°ƒç”¨å…¶å®ƒæœåŠ¡ã€‚

å¦‚æœæ­¤æ—¶ï¼ŒæŸä¸ªæœåŠ¡å‡ºç°å¼‚å¸¸ï¼š

![1562598487263](SpringCloud.assets/1562598487263.png)

ä¾‹å¦‚å¾®æœåŠ¡Iå‘ç”Ÿå¼‚å¸¸ï¼Œè¯·æ±‚é˜»å¡ï¼Œç”¨æˆ·ä¸ä¼šå¾—åˆ°å“åº”ï¼Œåˆ™tomcatçš„è¿™ä¸ªçº¿ç¨‹ä¸ä¼šé‡Šæ”¾ï¼Œäºæ˜¯è¶Šæ¥è¶Šå¤šçš„ç”¨æˆ·è¯·æ±‚åˆ°æ¥ï¼Œè¶Šæ¥è¶Šå¤šçš„çº¿ç¨‹ä¼šé˜»å¡ï¼š

![1562598566606](SpringCloud.assets/1562598566606.png) 

æœåŠ¡å™¨æ”¯æŒçš„çº¿ç¨‹å’Œå¹¶å‘æ•°æœ‰é™ï¼Œè¯·æ±‚ä¸€ç›´é˜»å¡ï¼Œä¼šå¯¼è‡´æœåŠ¡å™¨èµ„æºè€—å°½ï¼Œä»è€Œå¯¼è‡´æ‰€æœ‰å…¶å®ƒæœåŠ¡éƒ½ä¸å¯ç”¨ï¼Œå½¢æˆé›ªå´©æ•ˆåº”ã€‚

è¿™å°±å¥½æ¯”ï¼Œä¸€ä¸ªæ±½è½¦ç”Ÿäº§çº¿ï¼Œç”Ÿäº§ä¸åŒçš„æ±½è½¦ï¼Œéœ€è¦ä½¿ç”¨ä¸åŒçš„é›¶ä»¶ï¼Œå¦‚æœæŸä¸ªé›¶ä»¶å› ä¸ºç§ç§åŸå› æ— æ³•ä½¿ç”¨ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆæ•´å°è½¦æ— æ³•è£…é…ï¼Œé™·å…¥ç­‰å¾…é›¶ä»¶çš„çŠ¶æ€ï¼Œç›´åˆ°é›¶ä»¶åˆ°ä½ï¼Œæ‰èƒ½ç»§ç»­ç»„è£…ã€‚Â  æ­¤æ—¶å¦‚æœæœ‰å¾ˆå¤šä¸ªè½¦å‹éƒ½éœ€è¦è¿™ä¸ªé›¶ä»¶ï¼Œé‚£ä¹ˆæ•´ä¸ªå·¥å‚éƒ½å°†é™·å…¥ç­‰å¾…çš„çŠ¶æ€ï¼Œå¯¼è‡´æ‰€æœ‰ç”Ÿäº§éƒ½é™·å…¥ç˜«ç—ªã€‚ä¸€ä¸ªé›¶ä»¶çš„æ³¢åŠèŒƒå›´ä¸æ–­æ‰©å¤§ã€‚ 

Hystrixè§£å†³é›ªå´©é—®é¢˜çš„æ‰‹æ®µä¸»è¦æ˜¯**æœåŠ¡é™çº§**å’Œ**æœåŠ¡ç†”æ–­**ã€‚

### 7.1 Hystrixçš„çº¿ç¨‹éš”ç¦»åŸç†

çº¿ç¨‹éš”ç¦»ç¤ºæ„å›¾ï¼š

![1533829598310](SpringCloud.assets/1533829598310.png) 

è§£è¯»ï¼š

Hystrixä¸ºæ¯ä¸ª==ä¾èµ–æœåŠ¡è°ƒç”¨åˆ†é…ä¸€ä¸ªå°çš„çº¿ç¨‹æ± ==ï¼Œ**å¦‚æœçº¿ç¨‹æ± å·²æ»¡è°ƒç”¨å°†è¢«ç«‹å³æ‹’ç»ï¼Œé»˜è®¤ä¸é‡‡ç”¨æ’é˜Ÿ.è¿™æ ·æ˜¯ä¸ºäº†åŠ é€Ÿå¤±è´¥åˆ¤å®šæ—¶é—´**ã€‚æ­¤æ—¶ç”¨æˆ·çš„è¯·æ±‚å°†ä¸å†ç›´æ¥è®¿é—®æœåŠ¡ï¼Œè€Œæ˜¯é€šè¿‡çº¿ç¨‹æ± ä¸­çš„ç©ºé—²çº¿ç¨‹æ¥è®¿é—®æœåŠ¡ï¼Œå¦‚æœ**çº¿ç¨‹æ± å·²æ»¡**ï¼Œæˆ–è€…**è¯·æ±‚è¶…æ—¶**ï¼Œåˆ™ä¼šè¿›è¡Œé™çº§å¤„ç†ï¼Œä»€ä¹ˆæ˜¯æœåŠ¡é™çº§ï¼Ÿ

>  æœåŠ¡é™çº§ï¼šä¸»è¦æ˜¯é’ˆå¯¹éæ­£å¸¸æƒ…å†µä¸‹çš„åº”æ€¥æœåŠ¡æªæ–½ ï¼Œç›®çš„ä¸ºäº†ä¼˜å…ˆä¿è¯æ ¸å¿ƒæœåŠ¡ï¼Œè€Œéæ ¸å¿ƒæœåŠ¡ä¸å¯ç”¨æˆ–å¼±å¯ç”¨ã€‚

å½“ç”¨æˆ·çš„è¯·æ±‚æ•…éšœæ—¶ï¼Œä¸ä¼šè¢«é˜»å¡ï¼Œæ›´ä¸ä¼šæ— ä¼‘æ­¢çš„ç­‰å¾…æˆ–è€…çœ‹åˆ°ç³»ç»Ÿå´©æºƒï¼Œ==è‡³å°‘å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ‰§è¡Œç»“æœï¼ˆä¾‹å¦‚è¿”å›å‹å¥½çš„æç¤ºä¿¡æ¯ï¼‰== ã€‚è¿™æ ·å°±ä¸ä¼šå¯¼è‡´ç³»ç»Ÿå¡é¡¿å¼•èµ·é›ªå´©ã€‚

æœåŠ¡é™çº§è™½ç„¶ä¼š==å¯¼è‡´è¯·æ±‚å¤±è´¥ï¼Œä½†æ˜¯ä¸ä¼šå¯¼è‡´é˜»å¡ï¼Œè€Œä¸”æœ€å¤šä¼šå½±å“è¿™ä¸ªä¾èµ–æœåŠ¡å¯¹åº”çš„çº¿ç¨‹æ± ä¸­çš„èµ„æºï¼Œå¯¹å…¶å®ƒæœåŠ¡æ²¡æœ‰å“åº”ã€‚==

==å“ªäº›æƒ…å†µä¸‹ä¼šè§¦å‘é™çº§==ï¼š

- **<font color="red">ç¨‹åºè¿è¡Œå¼‚å¸¸</font>**
- **<font color="red">è¶…æ—¶è‡ªåŠ¨é™çº§</font>**
- æœåŠ¡ç†”æ–­è§¦å‘æœåŠ¡é™çº§
- ==**çº¿ç¨‹æ± ã€ä¿¡å·é‡æ‰“æ»¡ä¹Ÿä¼šå¯¼è‡´æœåŠ¡é™çº§**==
- äººå·¥é™çº§

### 7.2 Hystrixç†”æ–­å™¨çš„å…¥é—¨ä½¿ç”¨â­ğŸ

è¿™ä¸ªç†”æ–­å™¨å¯ä»¥é…ç½®ä¸­æœåŠ¡æä¾›æ–¹ï¼ˆè¯¦è§å¦ä¸€ä¸ªç¬”è®°ï¼‰ï¼Œä¹Ÿå¯ä»¥é…ç½®åœ¨æœåŠ¡æ¶ˆè´¹æ–¹ï¼Œè¿™é‡Œæˆ‘ä»¬é…ç½®åœ¨æœåŠ¡æ¶ˆè´¹æ–¹ã€‚

![](SpringCloud.assets/Snipaste_2022-05-14_09-45-56.png)

ä½¿ç”¨æ­¥éª¤å¦‚ä¸‹ï¼š

- 1.ç¼–å†™Hystrixèµ·æ­¥ä¾èµ–
- 2.åœ¨å¼•å¯¼ç±»åŠ å…¥Hystrixä½¿ç”¨æ³¨è§£**@EnableCircuitBreaker**
- 3.åœ¨éœ€è¦éš”ç¦»çš„æ–¹æ³•ä¸Šé…ç½®**@@HystrixCommand**

**å¯¼å…¥èµ·æ­¥ä¾èµ–**

~~~xml
<project xmlns="http://maven.apache.org/POM/4.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<groupId>com.atguigu</groupId>
	<artifactId>springcloud-consumer</artifactId>
	<version>0.0.1-SNAPSHOT</version>
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>2.0.1.RELEASE</version>
		<relativePath />
	</parent>

	<properties>
		<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
		<project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
		<java.version>1.8</java.version>
	</properties>

	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-web</artifactId>
		</dependency>
		<!-- Eurekaå®¢æˆ·ç«¯ -->
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
		</dependency>
        
        
		<!--æ·»åŠ Hystrixèµ·æ­¥ä¾èµ– -->
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-netflix-hystrix</artifactId>
		</dependency>
        
        
	</dependencies>

	<!-- SpringCloudçš„ä¾èµ– -->
	<dependencyManagement>
		<dependencies>
			<dependency>
				<groupId>org.springframework.cloud</groupId>
				<artifactId>spring-cloud-dependencies</artifactId>
				<version>Finchley.RC1</version>
				<type>pom</type>
				<scope>import</scope>
			</dependency>
		</dependencies>
	</dependencyManagement>
	<!-- Springçš„ä»“åº“åœ°å€ -->
	<repositories>
		<repository>
			<id>spring-milestones</id>
			<name>Spring Milestones</name>
			<url>https://repo.spring.io/milestone</url>
			<snapshots>
				<enabled>false</enabled>
			</snapshots>
		</repository>
	</repositories>
</project>
~~~

**åœ¨ä¸»å¯åŠ¨ç±»åŠ å…¥Hystrixä½¿ç”¨æ³¨è§£**

~~~java
package com.atguigu;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.cloud.netflix.hystrix.EnableHystrix;
import org.springframework.context.annotation.Bean;
import org.springframework.web.client.RestTemplate;

@SpringBootApplication
@EnableDiscoveryClient
@EnableCircuitBreaker  // å¼€å¯ç†”æ–­å™¨  å®é™…ä¸Šä¹Ÿæœ‰@EnableHystrix ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯ç”¨@EnableCircuitBreakerï¼Œ
public class ConsumerApplication {
	public static void main(String[] args) {
		SpringApplication.run(ConsumerApplication.class, args);
	}
	
	// åˆ›å»ºä¸€ä¸ªRestæ¨¡æ¿
	@Bean
	@LoadBalanced   // å¼€å¯è´Ÿè½½å‡è¡¡
	public RestTemplate restTemplate() {
		return  new RestTemplate();
	}

}
~~~

æˆ‘ä»¬ä¸ä½¿ç”¨@EnableHystrixï¼Œæ˜¯å› ä¸ºä½¿ç”¨@EnableCircuitBreaker ï¼Œè¿™æ ·çš„è¯ï¼Œè¿™ä¸‰ä¸ªæ³¨è§£@SpringBootApplicationã€
@EnableDiscoveryClientã€@EnableCircuitBreakerå°±å¯ä»¥ç”¨ä¸€ä¸ªæ³¨è§£**@SpringCloudApplication**ä»£æ›¿ã€‚==å¯åŠ¨ç±»ï¼ŒæœåŠ¡å‘ç°ï¼Œç†”æ–­å™¨==

~~~java
package org.springframework.cloud.client;

import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

import java.lang.annotation.*;

/**
 * @author Spencer Gibb
 */
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@SpringBootApplication
@EnableDiscoveryClient
@EnableCircuitBreaker
public @interface SpringCloudApplication {
}
~~~

**ç¼–å†™Hystrixé…ç½®ä»£ç **

~~~java
package com.atguigu.controller;

import java.util.List;
import java.util.Random;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.client.discovery.DiscoveryClient;
import org.springframework.scheduling.support.SimpleTriggerContext;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;

@RestController
public class ConsumerController {
	@Autowired
	private RestTemplate restTemplate;
	
	
	@HystrixCommand(
			// ç†”æ–­é™çº§çš„æ–¹æ³•æ˜¯å“ªä¸ªï¼Œå½“å‰Controllerå¼‚å¸¸ï¼Œè¶…æ—¶æ‰ä¼šè°ƒç”¨ç†”æ–­é™çº§çš„æ–¹æ³•
			fallbackMethod = "fallbackMethodConsumer"
			
			) // æ ‡è®°è¿™ä¸ªæ–¹æ³•éœ€è¦é™çº§
	@GetMapping("/consumer/{id}")
    public String consumer(@PathVariable Integer id) {
		// è´Ÿè½½å‡è¡¡ï¼šæŠŠipæ›¿æ¢æˆæœåŠ¡ID
    	String urlString = "http://USER-SERVICE/user/"+id;
    	// è¿œç¨‹è°ƒç”¨
    	String user = restTemplate.getForObject(urlString, String.class);
        return user;
	}
	
	/**
	 * è¿™ä¸ªæ˜¯ç†”æ–­çš„æ–¹æ³•ï¼Œå®ƒçš„è¦æ±‚å¦‚ä¸‹ï¼š
	 * 1.ç†”æ–­çš„æ–¹æ³•éœ€è¦å’Œè¢«è°ƒç”¨çš„æ–¹æ³•çš„å‚æ•°ç±»å‹ä¸€è‡´ï¼
	 * 2.ç†”æ–­çš„æ–¹æ³•éœ€è¦å’Œè¢«è°ƒç”¨çš„æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ä¸€è‡´ï¼
	 * 
	 */
	public String fallbackMethodConsumer(Integer id) {
		return "æœåŠ¡å™¨è¢«å¡å¡ç½—ç‰¹å¹²æ‰äº†ï¼Œè¯·ç¨åå†è¯•";
	}
	
}
~~~

**@HystrixCommand(fallbackMethod="fallbackMethodConsumer")ï¼šå£°æ˜ä¸€ä¸ªå¤±è´¥å›æ»šå¤„ç†å‡½æ•°fallbackMethodConsumerï¼Œå½“consumeræ‰§è¡Œè¶…æ—¶ï¼ˆé»˜è®¤æ˜¯1000æ¯«ç§’ï¼‰ï¼Œå°±ä¼šæ‰§è¡Œfallbackå‡½æ•°ï¼Œè¿”å›é”™è¯¯æç¤º**

æ­¤æ—¶æˆ‘ä»¬ä¸å¯åŠ¨æœåŠ¡æä¾›æ–¹ï¼Œæˆ‘ä»¬è®¿é—®http://localhost:8080/consumer/1ã€‚å¯ä»¥çœ‹åˆ°ï¼š

![](SpringCloud.assets/Snipaste_2022-05-14_10-18-54.png)

==éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œhystrixçº¿ç¨‹æ± ä¸­æ¯ä¸ªçº¿ç¨‹çš„å ç”¨æ—¶é—´ä¸º1ç§’ï¼Œå¦‚æœè¯·æ±‚è¶…è¿‡1ç§’æ²¡æœ‰è¿”å›ï¼Œåˆ™ç›´æ¥é™çº§==

### 7.3 Hystrixè¶…æ—¶é…ç½®â­ğŸ

çº¿ç¨‹éš”ç¦»è¶…æ—¶é»˜è®¤æ˜¯1000æ¯«ç§’ï¼Œå¦‚æœè¯·æ±‚è¶…è¿‡ä¸€ç§’ï¼Œåˆ™ä¼šé™çº§å¤„ç†ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä¿®æ”¹è¶…æ—¶æ—¶é—´ã€‚

~~~java
package com.atguigu.controller;

import java.util.List;
import java.util.Random;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.client.discovery.DiscoveryClient;
import org.springframework.scheduling.support.SimpleTriggerContext;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand;
import com.netflix.hystrix.contrib.javanica.annotation.HystrixProperty;

@RestController
public class ConsumerController {
	@Autowired
	private RestTemplate restTemplate;
	
	
	@HystrixCommand(
			// ç†”æ–­é™çº§çš„æ–¹æ³•æ˜¯å“ªä¸ªï¼Œå½“å‰Controllerå¼‚å¸¸ï¼Œè¶…æ—¶æ‰ä¼šè°ƒç”¨ç†”æ–­é™çº§çš„æ–¹æ³•
			fallbackMethod = "fallbackMethodConsumer",
			commandProperties = {
					@HystrixProperty(name="execution.isolation.thread.timeoutInMilliseconds",value="1000")// é…ç½®å±æ€§ï¼Œè¶…æ—¶æ—¶é—´ï¼Œå®é™…ç”Ÿäº§ä¼šå°äº1000
			}		
			) // æ ‡è®°è¿™ä¸ªæ–¹æ³•éœ€è¦é™çº§
	@GetMapping("/consumer/{id}")
    public String consumer(@PathVariable Integer id) {
		// è´Ÿè½½å‡è¡¡ï¼šæŠŠipæ›¿æ¢æˆæœåŠ¡ID
    	String urlString = "http://USER-SERVICE/user/"+id;
    	// è¿œç¨‹è°ƒç”¨
    	String user = restTemplate.getForObject(urlString, String.class);
        return user;
	}
	
	/**
	 * è¿™ä¸ªæ˜¯ç†”æ–­çš„æ–¹æ³•ï¼Œå®ƒçš„è¦æ±‚å¦‚ä¸‹ï¼š
	 * 1.ç†”æ–­çš„æ–¹æ³•éœ€è¦å’Œè¢«è°ƒç”¨çš„æ–¹æ³•çš„å‚æ•°ç±»å‹ä¸€è‡´ï¼
	 * 2.ç†”æ–­çš„æ–¹æ³•éœ€è¦å’Œè¢«è°ƒç”¨çš„æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ä¸€è‡´ï¼
	 * 
	 */
	public String fallbackMethodConsumer(Integer id) {
		return "æœåŠ¡å™¨è¢«å¡å¡ç½—ç‰¹å¹²æ‰äº†ï¼Œè¯·ç¨åå†è¯•";
	}
	
}
~~~

æˆ‘ä»¬é€šè¿‡@HystrixPropertyå±æ€§æŒ‡å®šè¶…æ—¶æ—¶é—´ï¼Œä½†æ˜¯æˆ‘ä»¬åªæ˜¯é…ç½®äº†å½“å‰æ–¹æ³•çš„è¶…æ—¶æ—¶é—´ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é…ç½®1å…¨å±€è¶…æ—¶æ—¶é—´ï¼è¿™éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®ã€‚å½“ç„¶ï¼Œ==ä¼˜å…ˆæ‰§è¡Œå±€éƒ¨é™çº§æ—¶é—´==ã€‚

~~~yaml
# ç«¯å£
server:
  port: 8080

# æ•°æ®æº
spring:
  application:
    name: user-consumer #å®šä¹‰æœåŠ¡ID
 
#eureké…ç½®
eureka:
  client:
    registry-fetch-interval-seconds: 30  #æœåŠ¡æ‹‰å–æ—¶é—´ï¼Œé»˜è®¤å€¼ä¹Ÿæ˜¯30ç§’ ç”Ÿäº§ç¯å¢ƒä¸€èˆ¬ä¸ä¼šæ”¹
    instance-info-replication-interval-seconds: 5 # å®ä¾‹æ›¿æ¢æ—¶é—´
    service-url: #å¤šä¸ªæ³¨å†Œä¸­å¿ƒï¼Œç”¨é€—å·åˆ†å‰²
      defaultZone: http://localhost:10086/eureka/
      
# å…¨å±€ç†”æ–­æ—¶é—´
hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 2000  
~~~

æ›´è¯¦ç»†çš„Hystrixä½¿ç”¨ï¼Œå¯ä»¥æŸ¥çœ‹å¦ä¸€ä¸ªç¬”è®°ã€‚

## 8.Gatewayç½‘å…³ç»„ä»¶â­ğŸ

### 8.1 ç½‘å…³æ¦‚è¿°

~~~markdown
# 1.è¯´æ˜
- ç½‘å…³ç»Ÿä¸€æœåŠ¡å…¥å£ï¼Œå¯æ–¹ä¾¿å®ç°å¯¹å¹³å°ä¼—å¤šæœåŠ¡æ¥å£è¿›è¡Œç®¡æ§ï¼Œå¯¹è®¿é—®æœåŠ¡çš„èº«ä»½è®¤è¯ã€é˜²æŠ¥æ–‡é‡æ”¾ä¸é˜²æ•°æ®ç¯¡æ”¹ã€åŠŸèƒ½è°ƒç”¨çš„ä¸šåŠ¡é‰´æƒã€å“åº”æ•°æ®çš„è„±æ•ã€æµé‡ä¸å¹¶å‘æ§åˆ¶ï¼Œç”šè‡³åŸºäºAPIè°ƒç”¨çš„è®¡é‡æˆ–è€…è®¡è´¹ç­‰ç­‰ã€‚

- ç½‘å…³ =  è·¯ç”±è½¬å‘ + è¿‡æ»¤å™¨
	`è·¯ç”±è½¬å‘ï¼šæ¥æ”¶ä¸€åˆ‡å¤–ç•Œè¯·æ±‚ï¼Œè½¬å‘åˆ°åç«¯çš„å¾®æœåŠ¡ä¸Šå»ï¼›
	`åœ¨æœåŠ¡ç½‘å…³ä¸­å¯ä»¥å®Œæˆä¸€ç³»åˆ—çš„æ¨ªåˆ‡åŠŸèƒ½ï¼Œä¾‹å¦‚æƒé™æ ¡éªŒã€é™æµä»¥åŠç›‘æ§ç­‰ï¼Œè¿™äº›éƒ½å¯ä»¥é€šè¿‡è¿‡æ»¤å™¨å®Œæˆ
	
# 2.ä¸ºä»€ä¹ˆéœ€è¦ç½‘å…³
 - 1.ç½‘å…³å¯ä»¥å®ç°æœåŠ¡çš„ç»Ÿä¸€ç®¡ç†ï¼ŒåŒæ—¶è§£å†³å‰ç«¯ç³»ç»Ÿåœ¨è®¿é—®å¾®æœåŠ¡æ˜¯çš„è·¯å¾„å¯ç»´æŠ¤ï¼Œä¿è¯ä¸€ä¸ªè´Ÿè½½å‡è¡¡çš„è½¬å‘ã€‚
 - 2.ç½‘å…³å¯ä»¥è§£å†³å¾®æœåŠ¡ä¸­é€šç”¨ä»£ç çš„å†—ä½™é—®é¢˜(å¦‚æƒé™æ§åˆ¶,æµé‡ç›‘æ§,é™æµç­‰)

# 3.ç½‘å…³ç»„ä»¶åœ¨å¾®æœåŠ¡ä¸­æ¶æ„
~~~

![](SpringCloud.assets/Snipaste_2022-05-14_13-58-17.png)

ç½‘å…³çš„ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š

**Routeè·¯ç”±**

è·¯ç”±æ˜¯æ„å»ºç½‘å…³çš„åŸºæœ¬æ¨¡å—ï¼Œ**å®ƒæ˜¯ç”±IDï¼Œç›®æ ‡URIï¼Œä¸€ç³»åˆ—çš„æ–­è¨€å’Œè¿‡æ»¤å™¨ç»„æˆ**ï¼Œå¦‚æœ==æ–­è¨€ä¸ºtrueåˆ™åŒ¹é…è¯¥è·¯ç”±==

**Predicateæ–­è¨€**

å¼€å‘äººå‘˜å¯ä»¥åŒ¹é…HTTPè¯·æ±‚ä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œå¦‚æœè¯·æ±‚ä¸æ–­è¨€ç›¸åŒ¹é…åˆ™è¿›è¡Œè·¯ç”±ã€‚

**Filterè¿‡æ»¤**

ä½¿ç”¨è¿‡æ»¤å™¨ï¼Œå¯ä»¥åœ¨è¯·æ±‚è¢«è·¯ç”±å‰æˆ–è€…ä¹‹åå¯¹è¯·æ±‚è¿›è¡Œä¿®æ”¹ã€‚è¯·æ±‚åˆ°æ¥æˆ–è€…è¿”å›éƒ½æ‰§è¡Œè¿‡æ»¤å™¨

**è·¯ç”±å†…åŒ…å«æ–­è¨€å’Œè¿‡æ»¤å™¨ï¼Œå¦‚æœæ–­è¨€ä¸ºtrueï¼Œåˆ™ä»£è¡¨åŒ¹é…ä¸Šè¯¥è·¯ç”±ï¼Œæ­¤æ—¶æ‰§è¡Œè¯¥è·¯ç”±å†…çš„è¿‡æ»¤å™¨æ–¹æ³•ã€‚**

![](SpringCloud.assets/Snipaste_2022-05-03_14-27-07.png)

![](SpringCloud.assets/Snipaste_2022-05-03_14-34-56.png)

ç½‘å…³çš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯ï¼š**è·¯ç”±è½¬å‘ï¼ˆåœ¨è½¬å‘çš„è¿‡ç¨‹ä¸­è¿˜å¯ä»¥å®ç°è´Ÿè½½å‡è¡¡ï¼‰+æ‰§è¡Œè¿‡æ»¤å™¨é“¾**

**å¸¸ç”¨ç½‘å…³ç»„ä»¶ï¼š**

#### 8.1.1 zuul

Zuul is the front door for all requests from devices and web sites to the backend of the Netflix streaming application. As an edge service application, Zuul is built to enable dynamic routing, monitoring, resiliency and security.

```markdown
# 0.åŸæ–‡ç¿»è¯‘
- https://github.com/Netflix/zuul/wiki
- zulæ˜¯ä»è®¾å¤‡å’Œç½‘ç«™åˆ°Netflixæµåª’ä½“åº”ç”¨ç¨‹åºåç«¯çš„æ‰€æœ‰è¯·æ±‚çš„å‰é—¨ã€‚ä½œä¸ºä¸€ä¸ªè¾¹ç¼˜æœåŠ¡åº”ç”¨ç¨‹åºï¼Œzulè¢«æ„å»ºä¸ºæ”¯æŒåŠ¨æ€è·¯ç”±ã€ç›‘è§†ã€å¼¹æ€§å’Œå®‰å…¨æ€§ã€‚

# 1.zuulç‰ˆæœ¬è¯´æ˜
- ç›®å‰zuulç»„ä»¶å·²ç»ä»1.0æ›´æ–°åˆ°2.0ï¼Œä½†æ˜¯ä½œä¸ºspringcloudå®˜æ–¹ä¸å†æ¨èä½¿ç”¨zuul2.0ï¼Œä½†æ˜¯ä¾ç„¶æ”¯æŒzuul2.

# 2.springcloud å®˜æ–¹é›†æˆzuulæ–‡æ¡£
- https://cloud.spring.io/spring-cloud-netflix/2.2.x/reference/html/#netflix-zuul-starter
```

#### 8.1.2 gateway

This project provides a library for building an API Gateway on top of Spring MVC. Spring Cloud Gateway aims to provide a simple, yet effective way to route to APIs and provide cross cutting concerns to them such as: security, monitoring/metrics, and resiliency.

```markdown
# 0.åŸæ–‡ç¿»è¯‘
- https://spring.io/projects/spring-cloud-gateway
- è¿™ä¸ªé¡¹ç›®æä¾›äº†ä¸€ä¸ªåœ¨springmvcä¹‹ä¸Šæ„å»ºAPIç½‘å…³çš„åº“ã€‚springcloudgatewayæ—¨åœ¨æä¾›ä¸€ç§ç®€å•è€Œæœ‰æ•ˆçš„æ–¹æ³•æ¥è·¯ç”±åˆ°apiï¼Œå¹¶ä¸ºapiæä¾›æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œæ¯”å¦‚ï¼šå®‰å…¨æ€§ã€ç›‘æ§/åº¦é‡å’Œå¼¹æ€§ã€‚

# 1.ç‰¹æ€§
- åŸºäºspringboot2.x å’Œ spring webFlux å’Œ Reactor æ„å»º å“åº”å¼å¼‚æ­¥éé˜»å¡IOæ¨¡å‹
- åŠ¨æ€è·¯ç”±
- è¯·æ±‚è¿‡æ»¤
```

### 8.2 ç½‘å…³å·¥ç¨‹æ­å»º

æˆ‘ä»¬ä½¿ç”¨å°šç¡…è°·çš„å·¥ç¨‹ä¸­çš„çˆ¶å·¥ç¨‹å’Œeurekaå·¥ç¨‹ï¼ŒåŒæ—¶æ–°å»ºä¸¤ä¸ªå­å·¥ç¨‹:spring-cloud-categoriesã€spring-cloud-videosã€‚è¿™ä¸¤ä¸ªå·¥ç¨‹ç»“æ„ä¸€è‡´ï¼Œä»£ç ç›¸ä¼¼ã€‚å¦‚ä¸‹ï¼š

- spring-cloud-categories

~~~xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>cloud2022</artifactId>
        <groupId>com.atguigu.springcloud</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>spring-cloud-categories</artifactId>
    <!--webä¾èµ– -->
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <!--ä¾èµ–Eurekaå®¢æˆ·ç«¯ï¼Œå³å½“å‰çš„å¾®æœåŠ¡å¯¹äºEureka Serveræ¥è®²ï¼Œæˆ‘ä»¬æ˜¯å®¢æˆ·ç«¯ -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
    </dependencies>


</project>
~~~

**å¯åŠ¨ç±»**

~~~java
package com.baizhi;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;

@SpringBootApplication
@EnableDiscoveryClient
public class CategoriesApplication {
    public static void main(String[] args) {
        SpringApplication.run(CategoriesApplication.class,args);
    }
}
~~~

**controller**

~~~java
package com.baizhi.controller;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class CategoriesController {
    private static final Logger log = LoggerFactory.getLogger(CategoriesController.class);

    @GetMapping("/categories")
    public String categories(){
        log.info("categories ok !!!");
        return "categories ok";
    }
}
~~~

**é…ç½®æ–‡ä»¶**

~~~yaml
server:
  port: 8989

spring:
  application:
    name: CATEGERIES

# é…ç½®Eurekaå®¢æˆ·ç«¯ï¼š
eureka:
  client:
    # å½“å‰8001å°±æ˜¯å®¢æˆ·ç«¯ï¼Œéœ€è¦å°†è‡ªå·±æ³¨å†Œåˆ°7001æ³¨å†Œä¸­å¿ƒä¸Šå»
    register-with-eureka: true
    # 80ä»7001ä¸Šè·å–æœåŠ¡åˆ—è¡¨ï¼ˆä¼šç¼“å­˜åˆ°æœ¬åœ°ï¼‰ï¼Œç”¨æ¥è°ƒç”¨å…¶ä»–çš„å¾®æœåŠ¡
    fetch-registry: true
    # å½“å‰å¾®æœåŠ¡ä½œä¸ºEurekaå®¢æˆ·ç«¯ï¼Œè¦æ³¨å†Œåˆ°Eureka Serverç«¯
    service-url:
      defaultZone: http://localhost:7001/eureka/   #å‘Šè¯‰ç°åœ¨Eurekaå®¢æˆ·ç«¯çœŸæ­£çš„æ³¨å†Œä¸­å¿ƒçš„åœ°å€
~~~

- spring-cloud-videos

~~~xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>cloud2022</artifactId>
        <groupId>com.atguigu.springcloud</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>spring-cloud-videos</artifactId>
    <!--webä¾èµ– -->
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <!--ä¾èµ–Eurekaå®¢æˆ·ç«¯ï¼Œå³å½“å‰çš„å¾®æœåŠ¡å¯¹äºEureka Serveræ¥è®²ï¼Œæˆ‘ä»¬æ˜¯å®¢æˆ·ç«¯ -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
        </dependency>
    </dependencies>

</project>
~~~

**å¯åŠ¨ç±»**

~~~java
package com.baizhi;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient
public class VideosApplication {
    public static void main(String[] args) {
        SpringApplication.run(VideosApplication.class,args);
    }
}

~~~

**controller**

~~~java
package com.baizhi.controller;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class VideosController {
    private static final Logger log = LoggerFactory.getLogger(VideosController.class);

    @GetMapping("/videos")
    public String videos(){
        log.info("videos ok !!!");
        return "videos ok";
    }
}
~~~

**é…ç½®æ–‡ä»¶**

~~~yaml
server:
  port: 9090

spring:
  application:
    name: VIDEOS

# é…ç½®Eurekaå®¢æˆ·ç«¯ï¼š
eureka:
  client:
    # å½“å‰å°±æ˜¯å®¢æˆ·ç«¯ï¼Œéœ€è¦å°†è‡ªå·±æ³¨å†Œåˆ°7001æ³¨å†Œä¸­å¿ƒä¸Šå»
    register-with-eureka: true
    # ä»7001ä¸Šè·å–æœåŠ¡åˆ—è¡¨ï¼ˆä¼šç¼“å­˜åˆ°æœ¬åœ°ï¼‰ï¼Œç”¨æ¥è°ƒç”¨å…¶ä»–çš„å¾®æœåŠ¡
    fetch-registry: true
    # å½“å‰å¾®æœåŠ¡ä½œä¸ºEurekaå®¢æˆ·ç«¯ï¼Œè¦æ³¨å†Œåˆ°Eureka Serverç«¯
    service-url:
      defaultZone: http://localhost:7001/eureka/   #å‘Šè¯‰ç°åœ¨Eurekaå®¢æˆ·ç«¯çœŸæ­£çš„æ³¨å†Œä¸­å¿ƒçš„åœ°å€
~~~

ä¸Šè¿°ä¸¤ä¸ªæœåŠ¡æä¾›è€…æ­å»ºå¥½äº†ä»¥åï¼Œæˆ‘ä»¬ç»§ç»­æ¥æ­å»ºç½‘å…³ã€‚==æˆ‘ä»¬å»ºè®®æ˜¯å°†ç½‘å…³å•ç‹¬ä½œä¸ºä¸€ä¸ªå’Œä¸šåŠ¡åŒºåˆ†å¼€çš„å·¥ç¨‹==ã€‚ã€‚éœ€è¦æ³¨æ„çš„æ˜¯**Gatewayç”±äºåº•å±‚ä½¿ç”¨Spring WebFluxæ¡†æ¶ï¼Œè¿™ä¸ªæ¡†æ¶å’ŒSpringMVCæ¡†æ¶æ˜¯å†²çªçš„ï¼Œæ•…æœ‰äº†gatewayçš„ä¾èµ–ä»¥åï¼Œä¸å…è®¸å‡ºç°spring-boot-starter-webï¼Œå¦åˆ™é¡¹ç›®å¯åŠ¨ä¼šæŠ¥é”™ï¼**

**é…ç½®æ–‡ä»¶pom.xml**

~~~xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>cloud2022</artifactId>
        <groupId>com.atguigu.springcloud</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>spring-cloud-gateway</artifactId>
   <dependencies>
       <!--å¼•å…¥gatewayç½‘å…³ä¾èµ– ä½¿ç”¨Spring WebFluxæ¨¡å‹ï¼Œå’Œä¼ ç»Ÿçš„SpringMVCmæ¨¡å‹å†²çª-->
       <dependency>
           <groupId>org.springframework.cloud</groupId>
           <artifactId>spring-cloud-starter-gateway</artifactId>
       </dependency>
       <dependency>
           <groupId>org.springframework.boot</groupId>
           <artifactId>spring-boot-starter-actuator</artifactId>
       </dependency>
       <!--ä¾èµ–Eurekaå®¢æˆ·ç«¯ï¼Œå³å½“å‰çš„å¾®æœåŠ¡å¯¹äºEureka Serveræ¥è®²ï¼Œæˆ‘ä»¬æ˜¯å®¢æˆ·ç«¯ -->
       <dependency>
           <groupId>org.springframework.cloud</groupId>
           <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
       </dependency>
   </dependencies>

</project>
~~~

**ä¸»å¯åŠ¨ç±»**

~~~java
package com.baizhi;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient
public class GatewayApplication {
    public static void main(String[] args) {
        SpringApplication.run(GatewayApplication.class,args);
    }
}
~~~

****

**é…ç½®æ–‡ä»¶**

~~~yaml
server:
  port: 8888

spring:
  application:
    name: GATEWAY

# é…ç½®Eurekaå®¢æˆ·ç«¯ï¼š
eureka:
  client:
    # å½“å‰å°±æ˜¯å®¢æˆ·ç«¯ï¼Œéœ€è¦å°†è‡ªå·±æ³¨å†Œåˆ°7001æ³¨å†Œä¸­å¿ƒä¸Šå»
    register-with-eureka: true
    # ä»7001ä¸Šè·å–æœåŠ¡åˆ—è¡¨ï¼ˆä¼šç¼“å­˜åˆ°æœ¬åœ°ï¼‰ï¼Œç”¨æ¥è°ƒç”¨å…¶ä»–çš„å¾®æœåŠ¡
    fetch-registry: true
    # å½“å‰å¾®æœåŠ¡ä½œä¸ºEurekaå®¢æˆ·ç«¯ï¼Œè¦æ³¨å†Œåˆ°Eureka Serverç«¯
    service-url:
      defaultZone: http://localhost:7001/eureka/   #å‘Šè¯‰ç°åœ¨Eurekaå®¢æˆ·ç«¯çœŸæ­£çš„æ³¨å†Œä¸­å¿ƒçš„åœ°å€
~~~

è¿™æ ·ä¸€ä¸ªåŸºæœ¬çš„ç½‘å…³å·¥ç¨‹å°±æ­å»ºå®Œæ¯•å•¦ã€‚

### 8.3  ç½‘å…³å®ç°è·¯ç”±è½¬å‘â­ğŸ

==1.å®Œå…¨å±•å¼€æ–¹å¼ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶æ–¹å¼é…ç½®ç½‘å…³è·¯ç”±==

~~~yaml
server:
  port: 8888

spring:
  application:
    name: GATEWAY
  cloud:
    gateway:
      routes: # ç”¨æ¥é…ç½®å¤šä¸ªè·¯ç”±è§„åˆ™ï¼Œä¸€ä¸ªè·¯ç”±è§„åˆ™å¯¹è±¡ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š 1ï¼šidï¼šå”¯ä¸€åç§°   2.è·¯ç”±è·¯å¾„ï¼ˆè½¬å‘çš„è·¯å¾„ï¼‰ 3.åŸºäºä»€ä¹ˆè§„åˆ™è½¬å‘
        - id: categories_route
          uri: http://localhost:8989/
          predicates:      # æŒ‡å®šè·¯ç”±è§„åˆ™
            - Path=/categories/**  # è¿™é‡Œä»£è¡¨åŸºäºè·¯å¾„çš„è§„åˆ™ï¼Œè·¯å¾„ä¸­å«æœ‰categoriesï¼Œ
        - id: vides_route
          uri: http://localhost:9090/
          predicates:      # æŒ‡å®šè·¯ç”±è§„åˆ™
            - Path=/videos/**    # è¿™é‡Œä»£è¡¨åŸºäºè·¯å¾„çš„è§„åˆ™ï¼Œè·¯å¾„ä¸­å«æœ‰vides




# é…ç½®Eurekaå®¢æˆ·ç«¯ï¼š
eureka:
  client:
    # å½“å‰å°±æ˜¯å®¢æˆ·ç«¯ï¼Œéœ€è¦å°†è‡ªå·±æ³¨å†Œåˆ°7001æ³¨å†Œä¸­å¿ƒä¸Šå»
    register-with-eureka: true
    fetch-registry: true
    # å½“å‰å¾®æœåŠ¡ä½œä¸ºEurekaå®¢æˆ·ç«¯ï¼Œè¦æ³¨å†Œåˆ°Eureka Serverç«¯
    service-url:
      defaultZone: http://localhost:7001/eureka/   #å‘Šè¯‰ç°åœ¨Eurekaå®¢æˆ·ç«¯çœŸæ­£çš„æ³¨å†Œä¸­å¿ƒçš„åœ°å€å°†æ‰€æœ‰
~~~

ç½‘å…³å°†æ‰€æœ‰å¾®æœåŠ¡ç»Ÿä¸€ç®¡ç†ï¼Œç¡®å®æœ‰å¥½å¤„ï¼Œä½†æ˜¯åˆšæ‰æˆ‘ä»¬è¿™æ ·é…ç½®ä¹Ÿé—®é¢˜ï¼Œ**å‡å¦‚æœåŠ¡å‡ºç°é›†ç¾¤ï¼Œæˆ‘ä»¬åœ¨uriä¸­ç›´æ¥å°†IPç«¯å£ç¡¬ç¼–ç ï¼Œæ˜¾ç„¶ä¸åˆé€‚ã€‚**è€Œç½‘å…³åº•å±‚é›†æˆäº†Ribbonï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®==ç½‘å…³åç§°é…ç½®é…ç½®URI==ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜ï¼

~~~yaml
server:
  port: 8888

spring:
  application:
    name: GATEWAY
  cloud:
    gateway:
      routes: # ç”¨æ¥é…ç½®å¤šä¸ªè·¯ç”±è§„åˆ™ï¼Œä¸€ä¸ªè·¯ç”±è§„åˆ™å¯¹è±¡ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š 1ï¼šidï¼šå”¯ä¸€åç§°   2.è·¯ç”±è·¯å¾„ï¼ˆè½¬å‘çš„è·¯å¾„ï¼‰ 3.åŸºäºä»€ä¹ˆè§„åˆ™è½¬å‘
        - id: categories_route
          # uri: http://localhost:8989/ è¿™ç§æ–¹å¼ç¼ºç‚¹ï¼Œæ²¡æœ‰è´Ÿè½½å‡è¡¡
          uri: lb://CATEGERIES       #lb:loadbalance è´Ÿè½½å‡è¡¡
          predicates:      # æŒ‡å®šè·¯ç”±è§„åˆ™
            - Path=/categories/**  # è¿™é‡Œä»£è¡¨åŸºäºè·¯å¾„çš„è§„åˆ™ï¼Œè·¯å¾„ä¸­å«æœ‰categoriesï¼Œ
        - id: vides_route
          # uri: http://localhost:9090/ è¿™ç§æ–¹å¼ç¼ºç‚¹ï¼Œæ²¡æœ‰è´Ÿè½½å‡è¡¡
          uri: lb://VIDEOS       #lb:loadbalance è´Ÿè½½å‡è¡¡
          predicates:      # æŒ‡å®šè·¯ç”±è§„åˆ™
            - Path=/videos/**    # è¿™é‡Œä»£è¡¨åŸºäºè·¯å¾„çš„è§„åˆ™ï¼Œè·¯å¾„ä¸­å«æœ‰vides

# é…ç½®Eurekaå®¢æˆ·ç«¯ï¼š
eureka:
  client:
    # å½“å‰å°±æ˜¯å®¢æˆ·ç«¯ï¼Œéœ€è¦å°†è‡ªå·±æ³¨å†Œåˆ°7001æ³¨å†Œä¸­å¿ƒä¸Šå»
    register-with-eureka: true
    # ä»7001ä¸Šè·å–æœåŠ¡åˆ—è¡¨ï¼ˆä¼šç¼“å­˜åˆ°æœ¬åœ°ï¼‰ï¼Œç”¨æ¥è°ƒç”¨å…¶ä»–çš„å¾®æœåŠ¡
    fetch-registry: true
    # å½“å‰å¾®æœåŠ¡ä½œä¸ºEurekaå®¢æˆ·ç«¯ï¼Œè¦æ³¨å†Œåˆ°Eureka Serverç«¯
    service-url:
      defaultZone: http://localhost:7001/eureka/   #å‘Šè¯‰ç°åœ¨Eurekaå®¢æˆ·ç«¯çœŸæ­£çš„æ³¨å†Œä¸­å¿ƒçš„åœ°å€
~~~

==2.åŸºäºç¼–ç¨‹çš„æ–¹å¼ï¼šä½¿ç”¨javaä»£ç æ–¹å¼é…ç½®ç½‘å…³è·¯ç”±==

è¿™ç§æ–¹å¼é…ç½®è·¯ç”±è§„åˆ™å°±ä¸éœ€è¦åœ¨é…ç½®æ–‡ä»¶å‡å¦‚è·¯ç”±é…ç½®ï¼Œ==**ç›´æ¥å°†é…ç½®å†™åœ¨javaç±»ä¸­**==ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š

~~~java
package com.baizhi.config;

import org.springframework.cloud.gateway.route.RouteLocator;
import org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration // ä»£è¡¨å½“å‰æ˜¯ä¸€ä¸ªé…ç½®ç±»
public class GatewayConfig {

    /**
     * Springå·¥å‚ä¸­å·²ç»é»˜è®¤æœ‰è¿™ä¸ªå¯¹è±¡å•¦ï¼šRouteLocatorBuilderï¼Œå¯ä»¥ç›´æ¥è¿å‚æ•°æ³¨å…¥è¿›æ¥
     */
    @Bean
    public RouteLocator routeLocator(RouteLocatorBuilder builder){
       return builder.routes()
               .route("categories_route",r -> r.path("/categories/**").uri("http://localhost:8989/"))// é…ç½®äº†ä¸€ä¸ªè·¯ç”±å¯¹è±¡
               .route("vides_route",r -> r.path("/videos/**").uri("http://localhost:9090/"))// é…ç½®äº†ä¸€ä¸ªè·¯ç”±å¯¹è±¡
               .build();
    }
}
~~~

ç½‘å…³ä¸­é™¤äº†æœ‰è·¯ç”±è¿˜æœ‰è¿‡æ»¤ï¼Œè¿‡æ»¤åˆåˆ†ä¸ºï¼š**å‰ç½®è¿‡æ»¤è¿˜æœ‰åç½®è¿‡æ»¤**,

- å‰ç½®è¿‡æ»¤æ˜¯é€šè¿‡==predicate==æ¥æ“ä½œçš„ã€‚æ»¡è¶³è¿™ä¸ªpredicateï¼Œè¯·æ±‚å°±ç•™ä¸‹æ¥ï¼Œä¸æ»¡è¶³è¿™ä¸ªpredicateï¼Œè¯·æ±‚å°±è¢«é˜»æ‹¦ã€‚predicateæ˜¯ç”¨æ¥æ ¡éªŒå½“å‰è¯·æ±‚æ˜¯å¦èƒ½å¤Ÿè¿›å…¥ç½‘å…³çš„æ ‡å‡†ã€‚æˆ‘ä»¬åœ¨å‰é¢çš„æ¡ˆä¾‹å°±æ˜¯é€šè¿‡è·¯å¾„==predicate==å®ç°è·¯ç”±è½¬å‘ã€‚
- ==æ»¡è¶³predicateï¼Œè¯·æ±‚åˆ™ç»è¿‡ç½‘å…³ï¼Œæ­¤æ—¶ç½‘å…³ä¼šå¯¹å…¶è¿›è¡Œè½¬å‘==ï¼Œæ­¤æ—¶æˆ‘ä»¬è¿˜å¯ä»¥å¯¹è¯·æ±‚è¿›è¡Œè¿‡æ»¤ï¼Œåšä¸€äº›é™„åŠ çš„æ“ä½œï¼Œå†è®©è¯·æ±‚è½¬å‘åˆ°å¯¹åº”çš„å¾®æœåŠ¡ã€‚**è¿‡æ»¤æ˜¯è¿›å…¥ç½‘å…³ä¹‹åï¼Œå†è½¬å‘å¾®æœåŠ¡ä¹‹å‰è¦ç»è¿‡çš„ä¸€äº›æ“ä½œï¼Œå¯ä»¥æ”¾åœ¨è¿‡æ»¤ä¸­ã€‚**

### 8.4 ç½‘å…³ä¸­çš„å¸¸ç”¨è·¯ç”±predicate(éªŒè¯)â­ğŸ

==**æ–­è¨€æ˜¯ç¡®å®šè¯·æ±‚èƒ½å¦è¿›å…¥ç½‘å…³ä¸­çš„æŸä¸ªè·¯ç”±å¯¹è±¡ã€‚**==

```markdown
# 1.Gatewayæ”¯æŒå¤šç§æ–¹å¼çš„predicate
```

![image-20200721112751340](SpringCloud.assets/image-20200721112751340.png)

```markdown
- After=2020-07-21T11:33:33.993+08:00[Asia/Shanghai]  		`æŒ‡å®šæ—¥æœŸä¹‹åçš„è¯·æ±‚è¿›è¡Œè·¯ç”±ï¼Œå¦‚æœå†æŒ‡å®šæ—¥æœŸä¹‹å‰ç›¸å½“äºè¯¥è·¯ç”±ä¸å­˜åœ¨
- Before=2020-07-21T11:33:33.993+08:00[Asia/Shanghai]       `æŒ‡å®šæ—¥æœŸä¹‹å‰çš„è¯·æ±‚è¿›è¡Œè·¯ç”±
- Between=2017-01-20T17:42:47.789-07:00[America/Denver], 2017-01-21T17:42:47.789-07:00[America/Denver]       `åœ¨æŒ‡å®šæ—¶é—´å†…è·¯ç”±æ‰ç”Ÿæ•ˆ
- Cookie=username,chenyn	`åŸºäºæŒ‡å®šcookieçš„è¯·æ±‚è¿›è¡Œè·¯ç”±
- Cookie=username,[A-Za-z0-9]+	`åŸºäºæŒ‡å®šcookieçš„è¯·æ±‚è¿›è¡Œè·¯ç”±	
	`curl http://localhost:8989/user/findAll --cookie "username=zhangsna"
- Header=X-Request-Id, \d+	    `åŸºäºè¯·æ±‚å¤´ä¸­çš„æŒ‡å®šå±æ€§çš„æ­£åˆ™åŒ¹é…è·¯ç”±(è¿™é‡Œå…¨æ˜¯æ•´æ•°)ï¼Œå¿…é¡»æºå¸¦æŒ‡å®šçš„è¯·æ±‚å¤´æ‰èƒ½è®¿é—® 
      `curl http://localhost:8989/user/findAll -H "X-Request-Id:11"
- Method=GET,POST	 `åŸºäºæŒ‡å®šçš„è¯·æ±‚æ–¹å¼è¯·æ±‚è¿›è¡Œè·¯ç”±,

- å®˜æ–¹æ›´å¤š: https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.3.RELEASE/reference/html/#the-cookie-route-predicate-factory
```

æ–­è¨€ä¸­çš„æ—¶é—´æ ¼å¼å¯ä»¥ié€šè¿‡å¦‚ä¸‹ä»£ç è·å–ï¼š

~~~java
package test;

import java.time.ZonedDateTime;

public class TestDemo {
    public static void main(String[] args) {
        ZonedDateTime zonedDateTime = ZonedDateTime.now();
        // 2022-05-03T15:36:54.285+08:00[GMT+08:00]
        System.out.println(zonedDateTime);
    }
}
~~~

### 8.5 å¸¸ç”¨çš„å±€éƒ¨Filterä»¥åŠè‡ªå®šä¹‰å±€éƒ¨filterâ­ğŸ

è¿‡æ»¤çš„ä»·å€¼ï¼š**å‡å°‘æ¯ä¸ªå¾®æœåŠ¡ä¸­çš„ä»£ç å†—ä½™ã€‚**

Route filters allow the modification of the incoming HTTP request or outgoing HTTP response in some manner. Route filters are scoped to a particular route. Spring Cloud Gateway includes many built-in GatewayFilter Factories.

```markdown
# 1.åŸæ–‡ç¿»è¯‘
- å®˜ç½‘: 
	https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.2.3.RELEASE/reference/html/#gatewayfilter-factories
	
- è·¯ç”±è¿‡æ»¤å™¨å…è®¸ä»¥æŸç§æ–¹å¼ä¿®æ”¹ä¼ å…¥çš„HTTPè¯·æ±‚æˆ–ä¼ å‡ºçš„HTTPå“åº”ã€‚è·¯ç”±ç­›é€‰å™¨çš„ä½œç”¨åŸŸæ˜¯ç‰¹å®šè·¯ç”±ã€‚springcloudgatewayåŒ…æ‹¬è®¸å¤šå†…ç½®çš„GatewayFilterå·¥å‚ã€‚

# 2.ä½œç”¨
- å½“æˆ‘ä»¬æœ‰å¾ˆå¤šä¸ªæœåŠ¡æ—¶ï¼Œæ¯”å¦‚ä¸‹å›¾ä¸­çš„user-serviceã€order-serviceã€product-serviceç­‰æœåŠ¡ï¼Œå®¢æˆ·ç«¯è¯·æ±‚å„ä¸ªæœåŠ¡çš„Apiæ—¶ï¼Œæ¯ä¸ªæœåŠ¡éƒ½éœ€è¦åšç›¸åŒçš„äº‹æƒ…ï¼Œæ¯”å¦‚é‰´æƒã€é™æµã€æ—¥å¿—è¾“å‡ºç­‰ã€‚
```

![image-20200721161002001](SpringCloud.assets/image-20200721161002001.png)

![image-20200721161421845](SpringCloud.assets/image-20200721161421845.png)



Springcloudå†…ç½®äº†å¾ˆå¤šFilterï¼Œå¦‚å›¾æ‰€ç¤ºï¼š

![](SpringCloud.assets/Snipaste_2022-05-15_10-07-12.png)

#### 8.5.1 å¸¸è§Filterçš„ä½¿ç”¨â­ğŸ

é…ç½®æ–‡ä»¶ä¸­æ¯ä¸ªè·¯ç”±é™¤äº†å¯ä»¥å†™idã€uriã€è¿˜æœ‰predicatesï¼Œè¿˜å¯ä»¥å†™filtersã€‚

~~~markdown
# AddRequestHeader GatewayFilter:ç»™è¯·æ±‚å¢åŠ è¯·æ±‚å¤´
~~~

**ç½‘å…³é…ç½®å¦‚ä¸‹ï¼š**

~~~yaml
server:
  port: 8888

spring:
  application:
    name: GATEWAY
  cloud:
    gateway:
      routes: # ç”¨æ¥é…ç½®å¤šä¸ªè·¯ç”±è§„åˆ™ï¼Œä¸€ä¸ªè·¯ç”±è§„åˆ™å¯¹è±¡ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š 1ï¼šidï¼šå”¯ä¸€åç§°   2.è·¯ç”±è·¯å¾„ï¼ˆè½¬å‘çš„è·¯å¾„ï¼‰ 3.åŸºäºä»€ä¹ˆè§„åˆ™è½¬å‘
        - id: categories_route
          uri: http://localhost:8989/
          predicates:      # æŒ‡å®šè·¯ç”±è§„åˆ™
            - Path=/categories/**  # è¿™é‡Œä»£è¡¨åŸºäºè·¯å¾„çš„è§„åˆ™ï¼Œè·¯å¾„ä¸­å«æœ‰categoriesï¼Œ
          filters:
            - AddRequestHeader=X-Request-red, blue  # ç»™å½“å‰çš„è¯·æ±‚å¢åŠ è¯·æ±‚å¤´
        - id: vides_route
          uri: http://localhost:9090/
          predicates:      # æŒ‡å®šè·¯ç”±è§„åˆ™
            - Path=/videos/**    # è¿™é‡Œä»£è¡¨åŸºäºè·¯å¾„çš„è§„åˆ™ï¼Œè·¯å¾„ä¸­å«æœ‰vid



# é…ç½®Eurekaå®¢æˆ·ç«¯ï¼š
eureka:
  client:
    # å½“å‰å°±æ˜¯å®¢æˆ·ç«¯ï¼Œéœ€è¦å°†è‡ªå·±æ³¨å†Œåˆ°7001æ³¨å†Œä¸­å¿ƒä¸Šå»
    register-with-eureka: true
    # ä»7001ä¸Šè·å–æœåŠ¡åˆ—è¡¨ï¼ˆä¼šç¼“å­˜åˆ°æœ¬åœ°ï¼‰ï¼Œç”¨æ¥è°ƒç”¨å…¶ä»–çš„å¾®æœåŠ¡
    fetch-registry: true
    # å½“å‰å¾®æœåŠ¡ä½œä¸ºEurekaå®¢æˆ·ç«¯ï¼Œè¦æ³¨å†Œåˆ°Eureka Serverç«¯
    service-url:
      defaultZone: http://localhost:7001/eureka/   #å‘Šè¯‰ç°åœ¨Eurekaå®¢æˆ·ç«¯çœŸæ­£çš„æ³¨å†Œä¸­å¿ƒçš„åœ°å€

~~~

**å¯¹åº”controllerä»£ç å¯ä»¥è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹**ï¼š

~~~java
package com.baizhi.controller;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;

@RestController
public class CategoriesController {
    private static final Logger log = LoggerFactory.getLogger(CategoriesController.class);

    @GetMapping("/categories")
    public String categories(HttpServletRequest request){
        log.info("categories ok !!!");
        String header = request.getHeader("X-Request-red");
        log.info("header:"+header);
        return "categories ok";
    }
}
~~~

æ­¤æ—¶æˆ‘ä»¬è®¿é—®ï¼šhttp://localhost:8888/categories

å¯ä»¥çœ‹åˆ°æ§åˆ¶å°æ‰“å°ï¼š

![](SpringCloud.assets/Snipaste_2022-05-15_10-24-05.png)

~~~markdown
# AddRequestParameter GatewayFilter:ç»™æ‰€æœ‰åŒ¹é…çš„è¯·æ±‚å¢åŠ å¯¹åº”çš„è¯·æ±‚å‚æ•°
~~~

**ç½‘å…³ä¸­é…ç½®æ–‡ä»¶ä¿®æ”¹**ï¼š

~~~yaml
server:
  port: 8888

spring:
  application:
    name: GATEWAY
  cloud:
    gateway:
      routes: # ç”¨æ¥é…ç½®å¤šä¸ªè·¯ç”±è§„åˆ™ï¼Œä¸€ä¸ªè·¯ç”±è§„åˆ™å¯¹è±¡ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š 1ï¼šidï¼šå”¯ä¸€åç§°   2.è·¯ç”±è·¯å¾„ï¼ˆè½¬å‘çš„è·¯å¾„ï¼‰ 3.åŸºäºä»€ä¹ˆè§„åˆ™è½¬å‘
        - id: categories_route
          uri: http://localhost:8989/
          predicates:      # æŒ‡å®šè·¯ç”±è§„åˆ™
            - Path=/categories/**  # è¿™é‡Œä»£è¡¨åŸºäºè·¯å¾„çš„è§„åˆ™ï¼Œè·¯å¾„ä¸­å«æœ‰categoriesï¼Œ
          filters:
            - AddRequestParameter=username, blue  # ç»™å½“å‰çš„è¯·æ±‚å¢åŠ è¯·æ±‚å‚æ•°
        - id: vides_route
          uri: http://localhost:9090/
          predicates:      # æŒ‡å®šè·¯ç”±è§„åˆ™
            - Path=/videos/**    # è¿™é‡Œä»£è¡¨åŸºäºè·¯å¾„çš„è§„åˆ™ï¼Œè·¯å¾„ä¸­å«æœ‰vid



# é…ç½®Eurekaå®¢æˆ·ç«¯ï¼š
eureka:
  client:
    # å½“å‰å°±æ˜¯å®¢æˆ·ç«¯ï¼Œéœ€è¦å°†è‡ªå·±æ³¨å†Œåˆ°7001æ³¨å†Œä¸­å¿ƒä¸Šå»
    register-with-eureka: true
    # ä»7001ä¸Šè·å–æœåŠ¡åˆ—è¡¨ï¼ˆä¼šç¼“å­˜åˆ°æœ¬åœ°ï¼‰ï¼Œç”¨æ¥è°ƒç”¨å…¶ä»–çš„å¾®æœåŠ¡
    fetch-registry: true
    # å½“å‰å¾®æœåŠ¡ä½œä¸ºEurekaå®¢æˆ·ç«¯ï¼Œè¦æ³¨å†Œåˆ°Eureka Serverç«¯
    service-url:
      defaultZone: http://localhost:7001/eureka/   #å‘Šè¯‰ç°åœ¨Eurekaå®¢æˆ·ç«¯çœŸæ­£çš„æ³¨å†Œä¸­å¿ƒçš„åœ°å€

~~~

****

**å¯¹åº”controllerä»£ç å¯ä»¥è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹**ï¼š

~~~java
package com.baizhi.controller;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;

@RestController
public class CategoriesController {
    private static final Logger log = LoggerFactory.getLogger(CategoriesController.class);

    @GetMapping("/categories")
    public String categories(String username){
        log.info("categories ok !!!");
        log.info("è·å–çš„è¯·æ±‚å‚æ•°username:"+username);
        return "categories ok";
    }
}
~~~

æ­¤æ—¶æŸ¥çœ‹åå°æ—¥å¿—ï¼š

~~~text
2022-05-15 10:32:05.909  INFO 11848 --- [nio-8989-exec-1] c.b.controller.CategoriesController      : categories ok !!!
2022-05-15 10:32:05.909  INFO 11848 --- [nio-8989-exec-1] c.b.controller.CategoriesController      : è·å–çš„è¯·æ±‚å‚æ•°username:blue
~~~

~~~markdown
# AddResponseHeader GatewayFilter:ç”¨æ¥ç»™è¯·æ±‚å¢åŠ ç›¸åº”çš„å“åº”å¤´ä¿¡æ¯
~~~

~~~markdown
# PrefixPath GatewayFilterï¼šç”¨æ¥ç»™è¯·æ±‚å¢åŠ å¯¹åº”çš„å‰ç½®è·¯å¾„
~~~

~~~markdown
# StripPrefix GatewayFilterï¼šç”¨æ¥ç»™è¯·æ±‚è·¯å¾„ä¸­å»æ‰nçº§å‰ç¼€ï¼Œä¼ 1å»æ‰1çº§å‰ç¼€ï¼Œä¼ 2å»æ‰2çº§å‰ç¼€
~~~

#### 8.5.2 è‡ªå®šä¹‰filter factoryâ­ğŸ

å®˜æ–¹ç»™æˆ‘ä»¬æä¾›äº†å¾ˆå¤šçš„Filterï¼Œå¦‚ä¸Šæ‰€è®²è§£ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ä¸€äº›Filterã€‚

æ ¼å¼å¦‚ä¸‹ï¼š

åœ¨åŒ…gateway.filter.factoryä¸­åˆ›å»ºä¸€ä¸ªç±»ï¼Œç±»åä»¥GatewayFilterFactoryç»“å°¾ï¼š

~~~java
package com.baizhi.gateway.filter.factory;

import org.springframework.cloud.gateway.filter.GatewayFilter;
import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactory;
import org.springframework.http.server.reactive.ServerHttpRequest;
import org.springframework.http.server.reactive.ServerHttpResponse;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

import java.util.List;

/**
 * è‡ªå®šä¹‰è®¤è¯çš„filterå·¥å‚
 * è¦æ±‚ï¼š
 *     1.ç»§æ‰¿AbstractGatewayFilterFactoryæŠ½è±¡ç±»
 *     2.åˆ›å»ºé™æ€å†…éƒ¨ç±»ä½œä¸ºæ³›å‹å‚æ•°
 *     3.å®ç°shortcutFieldOrderå’Œapplyæ–¹æ³•
 *     4.æ–°å»ºä¸€ä¸ªæ„é€ å™¨
 */
@Component   // æ³¨æ„ï¼šè¿™ä¸ªåœ°æ–¹è¦åœ¨å·¥å‚ä¸­åˆ›å»ºFilterå¯¹è±¡
public class TokenGatewayFilterFactory extends AbstractGatewayFilterFactory<TokenGatewayFilterFactory.Config> {
    // æ„é€ æ–¹æ³•
    public TokenGatewayFilterFactory(){
        super(Config.class);
    }

    @Override
    public List<String> shortcutFieldOrder() {
        return null;
    }

    @Override
    public GatewayFilter apply(Config config) {
       return new GatewayFilter() {
           /**
            * å‚æ•°1ï¼šspringMVCï¼šä¼ ç»Ÿwebæ¨¡å‹ï¼Œæœ‰HttpRequestå’ŒHttpResponse webFlux:æ–°çš„webæ¨¡å‹ å°†è¯·æ±‚å’Œå“åº”åˆå¹¶æˆä¸€ä¸ªå¯¹è±¡ï¼šServerWebExchange
            * å‚æ•°2ï¼šGatewayFilterChainï¼šç”¨æ¥æ”¾è¡Œè¯·æ±‚çš„
            */
           @Override
           public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
               ServerHttpRequest request = exchange.getRequest();// è·å–è¯·æ±‚
               ServerHttpResponse response = exchange.getResponse();// è·å–å“åº”
               System.out.println("è¿›å…¥è‡ªå®šä¹‰çš„TokenFilterã€‚ã€‚ã€‚ã€‚ã€‚ã€‚");
               Mono<Void> filter = chain.filter(exchange);
               System.out.println("è¿›å…¥è‡ªå®šä¹‰çš„TokenFilterã€‚ã€‚ã€‚ã€‚ã€‚ã€‚");
               return filter;// æ”¾è¡Œè¯·æ±‚
           }
       };
    }

    public static class Config{

    }
}
~~~

æ­¤æ—¶åœ¨å…¨å±€é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦å–æˆ‘ä»¬åˆ›å»ºçš„ç±»çš„ç±»å**TokenGatewayFilterFactory**çš„å»æ‰==GatewayFilterFactory**==çš„éƒ¨åˆ†ã€‚

~~~yaml
server:
  port: 8888

spring:
  application:
    name: GATEWAY
  cloud:
    gateway:
      routes: # ç”¨æ¥é…ç½®å¤šä¸ªè·¯ç”±è§„åˆ™ï¼Œä¸€ä¸ªè·¯ç”±è§„åˆ™å¯¹è±¡ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š 1ï¼šidï¼šå”¯ä¸€åç§°   2.è·¯ç”±è·¯å¾„ï¼ˆè½¬å‘çš„è·¯å¾„ï¼‰ 3.åŸºäºä»€ä¹ˆè§„åˆ™è½¬å‘
        - id: categories_route
          uri: http://localhost:8989/
          predicates:      # æŒ‡å®šè·¯ç”±è§„åˆ™
            - Path=/categories/**  # è¿™é‡Œä»£è¡¨åŸºäºè·¯å¾„çš„è§„åˆ™ï¼Œè·¯å¾„ä¸­å«æœ‰categoriesï¼Œ
          filters:
            - AddRequestParameter=username, blue  # ç»™å½“å‰çš„è¯·æ±‚å¢åŠ è¯·æ±‚å‚æ•°
            - Token
        - id: vides_route
          uri: http://localhost:9090/
          predicates:      # æŒ‡å®šè·¯ç”±è§„åˆ™
            - Path=/videos/**    # è¿™é‡Œä»£è¡¨åŸºäºè·¯å¾„çš„è§„åˆ™ï¼Œè·¯å¾„ä¸­å«æœ‰vid



# é…ç½®Eurekaå®¢æˆ·ç«¯ï¼š
eureka:
  client:
    # å½“å‰å°±æ˜¯å®¢æˆ·ç«¯ï¼Œéœ€è¦å°†è‡ªå·±æ³¨å†Œåˆ°7001æ³¨å†Œä¸­å¿ƒä¸Šå»
    register-with-eureka: true
    # ä»7001ä¸Šè·å–æœåŠ¡åˆ—è¡¨ï¼ˆä¼šç¼“å­˜åˆ°æœ¬åœ°ï¼‰ï¼Œç”¨æ¥è°ƒç”¨å…¶ä»–çš„å¾®æœåŠ¡
    fetch-registry: true
    # å½“å‰å¾®æœåŠ¡ä½œä¸ºEurekaå®¢æˆ·ç«¯ï¼Œè¦æ³¨å†Œåˆ°Eureka Serverç«¯
    service-url:
      defaultZone: http://localhost:7001/eureka/   #å‘Šè¯‰ç°åœ¨Eurekaå®¢æˆ·ç«¯çœŸæ­£çš„æ³¨å†Œä¸­å¿ƒçš„åœ°å€

~~~

æ­¤æ—¶æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ç”Ÿæ•ˆï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬å‘ç°åœ¨ä¸Šè¿°ç±»ä¸­æˆ‘ä»¬å¹¶æ²¡æœ‰å¯¹è‡ªå®šä¹‰å†…éƒ¨ç±»å’ŒshortcutFieldOrderæ–¹æ³•åšä»€ä¹ˆå¤„ç†ï¼Œå®é™…ä¸Š==è¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥è·å–é…ç½®æ–‡ä»¶ä¸­å¯¹åº”çš„å‚æ•°çš„==ã€‚

~~~yaml
server:
  port: 8888

spring:
  application:
    name: GATEWAY
  cloud:
    gateway:
      routes: # ç”¨æ¥é…ç½®å¤šä¸ªè·¯ç”±è§„åˆ™ï¼Œä¸€ä¸ªè·¯ç”±è§„åˆ™å¯¹è±¡ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š 1ï¼šidï¼šå”¯ä¸€åç§°   2.è·¯ç”±è·¯å¾„ï¼ˆè½¬å‘çš„è·¯å¾„ï¼‰ 3.åŸºäºä»€ä¹ˆè§„åˆ™è½¬å‘
        - id: categories_route
          uri: http://localhost:8989/
          predicates:      # æŒ‡å®šè·¯ç”±è§„åˆ™
            - Path=/categories/**  # è¿™é‡Œä»£è¡¨åŸºäºè·¯å¾„çš„è§„åˆ™ï¼Œè·¯å¾„ä¸­å«æœ‰categoriesï¼Œ
          filters:
            - AddRequestParameter=username, blue  # ç»™å½“å‰çš„è¯·æ±‚å¢åŠ è¯·æ±‚å‚æ•°
            - Token=true
        - id: vides_route
          uri: http://localhost:9090/
          predicates:      # æŒ‡å®šè·¯ç”±è§„åˆ™
            - Path=/videos/**    # è¿™é‡Œä»£è¡¨åŸºäºè·¯å¾„çš„è§„åˆ™ï¼Œè·¯å¾„ä¸­å«æœ‰vid



# é…ç½®Eurekaå®¢æˆ·ç«¯ï¼š
eureka:
  client:
    # å½“å‰å°±æ˜¯å®¢æˆ·ç«¯ï¼Œéœ€è¦å°†è‡ªå·±æ³¨å†Œåˆ°7001æ³¨å†Œä¸­å¿ƒä¸Šå»
    register-with-eureka: true
    # ä»7001ä¸Šè·å–æœåŠ¡åˆ—è¡¨ï¼ˆä¼šç¼“å­˜åˆ°æœ¬åœ°ï¼‰ï¼Œç”¨æ¥è°ƒç”¨å…¶ä»–çš„å¾®æœåŠ¡
    fetch-registry: true
    # å½“å‰å¾®æœåŠ¡ä½œä¸ºEurekaå®¢æˆ·ç«¯ï¼Œè¦æ³¨å†Œåˆ°Eureka Serverç«¯
    service-url:
      defaultZone: http://localhost:7001/eureka/   #å‘Šè¯‰ç°åœ¨Eurekaå®¢æˆ·ç«¯çœŸæ­£çš„æ³¨å†Œä¸­å¿ƒçš„åœ°å€
~~~

å¦‚æ­¤æ—¶æˆ‘ä»¬ç»™ä¸Šè¿°è‡ªå®šä¹‰è¿‡æ»¤å™¨é…ç½®å‚æ•°ä¸ºtrueï¼Œé‚£æˆ‘ä»¬å¦‚ä½•åœ¨è‡ªå®šè¿‡æ»¤å™¨ä¸­è·å–è¿™ä¸ªtrueå‘¢ï¼Œå°±éœ€è¦ç”¨åˆ°Configç±»å’ŒshortcutFieldOrderæ–¹æ³•ï¼š

~~~java
package com.baizhi.gateway.filter.factory;

import org.springframework.cloud.gateway.filter.GatewayFilter;
import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactory;
import org.springframework.http.server.reactive.ServerHttpRequest;
import org.springframework.http.server.reactive.ServerHttpResponse;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

import java.util.Collections;
import java.util.List;

/**
 * è‡ªå®šä¹‰è®¤è¯çš„filterå·¥å‚
 * è¦æ±‚ï¼š
 *     1.ç»§æ‰¿AbstractGatewayFilterFactoryæŠ½è±¡ç±»
 *     2.åˆ›å»ºé™æ€å†…éƒ¨ç±»ä½œä¸ºæ³›å‹å‚æ•°
 *     3.å®ç°shortcutFieldOrderå’Œapplyæ–¹æ³•
 *     4.æ–°å»ºä¸€ä¸ªæ„é€ å™¨
 */
@Component   // æ³¨æ„ï¼šè¿™ä¸ªåœ°æ–¹è¦åœ¨å·¥å‚ä¸­åˆ›å»ºFilterå¯¹è±¡
public class TokenGatewayFilterFactory extends AbstractGatewayFilterFactory<TokenGatewayFilterFactory.Config> {
    // æ„é€ æ–¹æ³•
    public TokenGatewayFilterFactory(){
        super(Config.class);
    }

    // ç”¨æ¥é…ç½®å°†ä¼ é€’çš„å‚æ•°èµ‹å€¼ç»™configä¸­çš„é‚£ä¸ªå˜é‡
    @Override
    public List<String> shortcutFieldOrder() {
        return Collections.singletonList("requestToken");// ç”¨æ¥å°†configä¸­å®šä¹‰çš„å˜é‡è¿”å›
    }

    @Override
    public GatewayFilter apply(Config config) {
       return new GatewayFilter() {
           /**
            * å‚æ•°1ï¼šspringMVCï¼šä¼ ç»Ÿwebæ¨¡å‹ï¼Œæœ‰HttpRequestå’ŒHttpResponse webFlux:æ–°çš„webæ¨¡å‹ å°†è¯·æ±‚å’Œå“åº”åˆå¹¶æˆä¸€ä¸ªå¯¹è±¡ï¼šServerWebExchange
            * å‚æ•°2ï¼šGatewayFilterChainï¼šç”¨æ¥æ”¾è¡Œè¯·æ±‚çš„
            */
           @Override
           public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
               ServerHttpRequest request = exchange.getRequest();// è·å–è¯·æ±‚
               ServerHttpResponse response = exchange.getResponse();// è·å–å“åº”

               System.out.println(config.requestToken);
               
               System.out.println("è¿›å…¥è‡ªå®šä¹‰çš„TokenFilterã€‚ã€‚ã€‚ã€‚ã€‚ã€‚");
               Mono<Void> filter = chain.filter(exchange);
               System.out.println("è¿›å…¥è‡ªå®šä¹‰çš„TokenFilterã€‚ã€‚ã€‚ã€‚ã€‚ã€‚");
               return filter;// æ”¾è¡Œè¯·æ±‚
           }
       };
    }
   
    /*
    *è¿™ä¸ªé‡Œé¢çš„æˆå‘˜å˜é‡ä»£è¡¨é…ç½®æ–‡ä»¶ä¸­å‚æ•°ä¸ªæ•°ï¼Œå¦‚æœæœ‰å¤šä¸ªå‚æ•°ï¼Œåˆ™éœ€è¦å®šä¹‰å¤šä¸ª
    *
    */
    public static class Config{
       private boolean requestToken; // ä¸€å®šè¦æœ‰getter/setter

        public boolean isRequestToken() {
            return requestToken;
        }

        public void setRequestToken(boolean requestToken) {
            this.requestToken = requestToken;
        }
    }
}
~~~

å—¯å¦‚æœç¡®å®šåªéœ€è¦ä¼ ä¸¤ä¸ªå‚æ•°ï¼Œä¸”å‚æ•°ä¸ä¸ºç©ºã€‚æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å¦‚ä¸‹è‡ªå®šä¹‰filter

![](SpringCloud.assets/Snipaste_2022-05-15_12-39-27.png)

### 8.6 è‡ªå®šä¹‰å…¨å±€filter

æˆ‘è›®åœ¨å‰é¢ä»‹ç»çš„Filteréƒ½æ˜¯é’ˆå¯¹æŸä¸ªè·¯ç”±å»è®¾ç½®ä½¿ç”¨çš„ï¼Œå‡å¦‚è·¯ç”±å¤šäº†ï¼Œå°±éœ€è¦æ¯ä¸ªè·¯ç”±è¿›è¡Œé…ç½®ï¼Œä¸Šè¿°flteréƒ½æ˜¯å±€éƒ¨çš„è¿‡æ»¤å™¨ã€‚è¿™æ ·æ˜¾ç„¶ä¸åˆç†ï¼Œå®é™…ä¸Šgatewayè¿˜æœ‰å…¨å±€filterï¼Œä¹Ÿå°±æ˜¯é’ˆå¯¹æ‰€æœ‰è¯·æ±‚éƒ½æœ‰æ•ˆã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å…¨å±€Filterã€‚

~~~java
package com.baizhi.filters;

import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.cloud.gateway.filter.GlobalFilter;
import org.springframework.core.Ordered;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

// é…ç½®ä¸€ä¸ªå…¨å±€çš„Filter
@Component
public class CustomerGlobalFilter implements GlobalFilter, Ordered {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        System.out.println("è¿›å…¥å…¨å±€Filterã€‚ã€‚ã€‚ã€‚");
        Mono<Void> filter = chain.filter(exchange);
        System.out.println("å›åˆ°å…¨å±€Filterã€‚ã€‚ã€‚ã€‚");
        return filter;
    }

    /*
       order:æ’åº
       1.è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªintç±»å‹çš„æ•°æ®ã€‚ç”¨æ¥ä»£è¡¨æ‰§è¡Œé¡ºåº
       2.é»˜è®¤æŒ‰ç…§è‡ªç„¶æ’åº 1 2 3 4 5
       3.-1ï¼šåœ¨æ‰€æœ‰çš„Filterä¹‹å‰æ‰§è¡Œ
     */
    @Override
    public int getOrder() {
        return -1;
    }
}
~~~

æ³¨æ„ï¼š==**å…¨å±€Filterä¸éœ€è¦å†é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®ï¼Œç›´æ¥è®©Springç®¡ç†å³å¯**==